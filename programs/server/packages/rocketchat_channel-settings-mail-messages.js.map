{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat_channel-settings-mail-messages/server/lib/startup.coffee","meteor://ðŸ’»app/packages/rocketchat_channel-settings-mail-messages/server/methods/mailMessages.coffee"],"names":[],"mappings":"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","file":"/packages/rocketchat_channel-settings-mail-messages.js","sourcesContent":["Meteor.startup ->\n\tpermission = { _id: 'mail-messages', roles : [ 'admin' ] }\n\tRocketChat.models.Permissions.upsert( permission._id, { $setOnInsert : permission })\n","Meteor.methods\n\t'mailMessages': (data) ->\n\t\tif not Meteor.userId()\n\t\t\tthrow new Meteor.Error('error-invalid-user', \"Invalid user\", { method: 'mailMessages' })\n\n\t\tcheck(data, Match.ObjectIncluding({ rid: String, to_users: [ String ], to_emails: String, subject: String, messages: [ String ], language: String }))\n\n\t\troom = Meteor.call 'canAccessRoom', data.rid, Meteor.userId()\n\t\tunless room\n\t\t\tthrow new Meteor.Error('error-invalid-room', \"Invalid room\", { method: 'mailMessages' })\n\n\t\tunless RocketChat.authz.hasPermission(Meteor.userId(), 'mail-messages')\n\t\t\tthrow new Meteor.Error 'error-action-not-allowed', 'Mailing is not allowed', { method: 'mailMessages', action: 'Mailing' }\n\n\t\trfcMailPatternWithName = /^(?:.*<)?([a-zA-Z0-9.!#$%&'*+\\/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*)(?:>?)$/\n\n\t\temails = _.compact(data.to_emails.trim().split(','))\n\t\tmissing = []\n\t\tif data.to_users.length > 0\n\t\t\tfor username in data.to_users\n\t\t\t\tuser = RocketChat.models.Users.findOneByUsername(username)\n\t\t\t\tif user?.emails?[0]?.address\n\t\t\t\t\temails.push user.emails[0].address\n\t\t\t\telse\n\t\t\t\t\tmissing.push username\n\t\tconsole.log emails\n\t\tfor email in emails\n\t\t\tunless rfcMailPatternWithName.test email.trim()\n\t\t\t\tthrow new Meteor.Error('error-invalid-email', \"Invalid email #{email}\", { method: 'mailMessages', email: email })\n\n\t\tuser = Meteor.user()\n\t\tname = user.name\n\t\temail = user.emails?[0]?.address\n\n\t\tdata.language = data.language.split('-').shift().toLowerCase()\n\n\t\tif data.language isnt 'en'\n\t\t\tlocaleFn = Meteor.call 'loadLocale', data.language\n\t\t\tif localeFn\n\t\t\t\tFunction(localeFn)()\n\n\t\thtml = \"\"\n\n\t\theader = RocketChat.placeholders.replace(RocketChat.settings.get('Email_Header') || \"\")\n\t\tfooter = RocketChat.placeholders.replace(RocketChat.settings.get('Email_Footer') || \"\")\n\n\t\tRocketChat.models.Messages.findByRoomIdAndMessageIds(data.rid, data.messages, { sort: { ts: 1 } }).forEach (message) ->\n\t\t\tdateTime = moment(message.ts).locale(data.language).format('L LT')\n\t\t\thtml += \"<p style='margin-bottom: 5px'><b>#{message.u.username}</b> <span style='color: #aaa; font-size: 12px'>#{dateTime}</span><br />\" + RocketChat.Message.parse(message, data.language) + \"</p>\"\n\n\t\tMeteor.defer ->\n\t\t\tEmail.send\n\t\t\t\tto: emails\n\t\t\t\tfrom: RocketChat.settings.get('From_Email')\n\t\t\t\treplyTo: email\n\t\t\t\tsubject: data.subject\n\t\t\t\thtml: header + html + footer\n\n\t\t\tconsole.log 'Sending email to ' + emails.join(', ')\n\n\t\treturn { success: true, missing: missing }\n"]}