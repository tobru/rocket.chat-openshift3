{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat_mailer/lib/Mailer.coffee","meteor://ðŸ’»app/packages/rocketchat_mailer/server/startup.coffee","meteor://ðŸ’»app/packages/rocketchat_mailer/server/models/Users.coffee","meteor://ðŸ’»app/packages/rocketchat_mailer/server/functions/sendMail.coffee","meteor://ðŸ’»app/packages/rocketchat_mailer/server/functions/unsubscribe.coffee","meteor://ðŸ’»app/packages/rocketchat_mailer/server/methods/sendMail.coffee","meteor://ðŸ’»app/packages/rocketchat_mailer/server/methods/unsubscribe.coffee"],"names":[],"mappings":"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","file":"/packages/rocketchat_mailer.js","sourcesContent":["Mailer = {}\n","Meteor.startup ->\n\tRocketChat.models.Permissions.upsert( 'access-mailer', { $setOnInsert : { _id: 'access-mailer', roles : ['admin'] } })\n","# Extends model Users\n\nRocketChat.models.Users.RocketMailUnsubscribe = (_id, createdAt) ->\n\n\tquery =\n\t\t_id: _id\n\t\tcreatedAt: new Date(parseInt createdAt)\n\n\tupdate =\n\t\t$set:\n\t\t\t\"mailer.unsubscribed\": true\n\n\taffectedRows = @update query, update\n\n\tconsole.log '[Mailer:Unsubscribe]', _id, createdAt, new Date(parseInt createdAt), affectedRows\n\n\treturn affectedRows\n","Mailer.sendMail = (from, subject, body, dryrun, query) ->\n\n\trfcMailPatternWithName = /^(?:.*<)?([a-zA-Z0-9.!#$%&'*+\\/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*)(?:>?)$/\n\t# rfcMailPattern = /^[a-zA-Z0-9.!#$%&'*+\\/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/\n\n\tunless rfcMailPatternWithName.test from\n\t\tthrow new Meteor.Error 'error-invalid-from-address', 'Invalid from address', { function: 'Mailer.sendMail' }\n\n\tif body.indexOf('[unsubscribe]') is -1\n\t\tthrow new Meteor.Error 'error-missing-unsubscribe-link', 'You must provide the [unsubscribe] link.', { function: 'Mailer.sendMail' }\n\n\theader = RocketChat.placeholders.replace(RocketChat.settings.get('Email_Header') || '');\n\tfooter = RocketChat.placeholders.replace(RocketChat.settings.get('Email_Footer') || '');\n\n\tuserQuery = { \"mailer.unsubscribed\": { $exists: 0 } }\n\tif query\n\t\tuserQuery = { $and: [ userQuery, EJSON.parse(query) ] }\n\n\tif dryrun\n\t\tMeteor.users.find({ \"emails.address\": from }).forEach (user) ->\n\t\t# Meteor.users.find({ \"username\": /\\.rocket\\.team/ }).forEach (user) ->\n\t\t\temail = user.emails?[0]?.address\n\n\t\t\thtml = RocketChat.placeholders.replace(body, {\n\t\t\t\tunsubscribe: Meteor.absoluteUrl(FlowRouter.path('mailer/unsubscribe/:_id/:createdAt', { _id: user._id, createdAt: user.createdAt.getTime() })),\n\t\t\t\tname: user.name,\n\t\t\t\temail: email\n\t\t\t});\n\n\t\t\temail = \"#{user.name} <#{email}>\"\n\n\t\t\tif rfcMailPatternWithName.test email\n\t\t\t\tMeteor.defer ->\n\t\t\t\t\tEmail.send\n\t\t\t\t\t\tto: email\n\t\t\t\t\t\tfrom: from\n\t\t\t\t\t\tsubject: subject\n\t\t\t\t\t\thtml: header + html + footer\n\n\t\t\t\tconsole.log 'Sending email to ' + email\n\n\telse\n\t\tMeteor.users.find({ \"mailer.unsubscribed\": { $exists: 0 } }).forEach (user) ->\n\t\t# Meteor.users.find({ \"username\": /\\.rocket\\.team/ }).forEach (user) ->\n\t\t\temail = user.emails?[0]?.address\n\n\t\t\thtml = RocketChat.placeholders.replace(body, {\n\t\t\t\tunsubscribe: Meteor.absoluteUrl(FlowRouter.path('mailer/unsubscribe/:_id/:createdAt', { _id: user._id, createdAt: user.createdAt.getTime() })),\n\t\t\t\tname: user.name,\n\t\t\t\temail: email\n\t\t\t});\n\n\t\t\temail = \"#{user.name} <#{email}>\"\n\n\t\t\tif rfcMailPatternWithName.test email\n\t\t\t\tMeteor.defer ->\n\t\t\t\t\tEmail.send\n\t\t\t\t\t\tto: email\n\t\t\t\t\t\tfrom: from\n\t\t\t\t\t\tsubject: subject\n\t\t\t\t\t\thtml: header + html + footer\n\n\t\t\t\tconsole.log 'Sending email to ' + email\n","Mailer.unsubscribe = (_id, createdAt) ->\n\tif _id and createdAt\n\t\treturn RocketChat.models.Users.RocketMailUnsubscribe(_id, createdAt) == 1\n\treturn false\n","Meteor.methods\n\t'Mailer.sendMail': (from, subject, body, dryrun, query) ->\n\t\tif not Meteor.userId()\n\t\t\tthrow new Meteor.Error 'error-invalid-user', \"Invalid user\", { method: 'Mailer.sendMail' }\n\n\t\tunless RocketChat.authz.hasRole( Meteor.userId(), 'admin') is true\n\t\t\tthrow new Meteor.Error 'error-not-allowed', 'Not allowed', { method: 'Mailer.sendMail' }\n\n\t\treturn Mailer.sendMail from, subject, body, dryrun, query\n\n# Limit setting username once per minute\n# DDPRateLimiter.addRule\n# \ttype: 'method'\n# \tname: 'Mailer.sendMail'\n# \tconnectionId: -> return true\n# , 1, 60000\n","Meteor.methods\n\t'Mailer:unsubscribe': (_id, createdAt) ->\n\t\treturn Mailer.unsubscribe _id, createdAt\n\n# Limit setting username once per minute\nDDPRateLimiter.addRule\n\ttype: 'method'\n\tname: 'Mailer:unsubscribe'\n\tconnectionId: -> return true\n, 1, 60000\n"]}