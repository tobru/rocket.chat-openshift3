{"version":3,"sources":["meteor://ğŸ’»app/packages/rocketchat_custom-oauth/custom_oauth_server.coffee"],"names":[],"mappings":"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","file":"/packages/rocketchat_custom-oauth.js","sourcesContent":["Services = {}\n\nclass CustomOAuth\n\tconstructor: (@name, options) ->\n\t\tif not Match.test @name, String\n\t\t\treturn throw new Meteor.Error 'CustomOAuth: Name is required and must be String'\n\n\t\tif Services[@name]?\n\t\t\tServices[@name].configure options\n\t\t\treturn\n\n\t\tServices[@name] = @\n\n\t\t@configure options\n\n\t\t@userAgent = \"Meteor\"\n\t\tif Meteor.release\n\t\t\t@userAgent += '/' + Meteor.release\n\n\t\tAccounts.oauth.registerService @name\n\t\t@registerService()\n\n\tconfigure: (options) ->\n\t\tif not Match.test options, Object\n\t\t\treturn throw new Meteor.Error 'CustomOAuth: Options is required and must be Object'\n\n\t\tif not Match.test options.serverURL, String\n\t\t\treturn throw new Meteor.Error 'CustomOAuth: Options.serverURL is required and must be String'\n\n\t\tif not Match.test options.tokenPath, String\n\t\t\toptions.tokenPath = '/oauth/token'\n\n\t\tif not Match.test options.identityPath, String\n\t\t\toptions.identityPath = '/me'\n\n\t\t@serverURL = options.serverURL\n\t\t@tokenPath = options.tokenPath\n\t\t@identityPath = options.identityPath\n\t\t@tokenSentVia = options.tokenSentVia\n\n\t\tif not /^https?:\\/\\/.+/.test @tokenPath\n\t\t\t@tokenPath = @serverURL + @tokenPath\n\n\t\tif not /^https?:\\/\\/.+/.test @identityPath\n\t\t\t@identityPath = @serverURL + @identityPath\n\n\t\tif Match.test options.addAutopublishFields, Object\n\t\t\tAccounts.addAutopublishFields options.addAutopublishFields\n\n\tgetAccessToken: (query) ->\n\t\tconfig = ServiceConfiguration.configurations.findOne service: @name\n\t\tif not config?\n\t\t\tthrow new ServiceConfiguration.ConfigError()\n\n\t\tresponse = undefined\n\t\ttry\n\t\t\tresponse = HTTP.post @tokenPath,\n\t\t\t\tauth: config.clientId + ':' + OAuth.openSecret(config.secret)\n\t\t\t\theaders:\n\t\t\t\t\tAccept: 'application/json'\n\t\t\t\t\t'User-Agent': @userAgent\n\t\t\t\tparams:\n\t\t\t\t\tcode: query.code\n\t\t\t\t\tclient_id: config.clientId\n\t\t\t\t\tclient_secret: OAuth.openSecret(config.secret)\n\t\t\t\t\tredirect_uri: OAuth._redirectUri(@name, config)\n\t\t\t\t\tgrant_type: 'authorization_code'\n\t\t\t\t\tstate: query.state\n\n\t\tcatch err\n\t\t\terror = new Error(\"Failed to complete OAuth handshake with #{@name} at #{@tokenPath}. \" + err.message)\n\t\t\tthrow _.extend error, {response: err.response}\n\n\t\tif response.data.error #if the http response was a json object with an error attribute\n\t\t\tthrow new Error(\"Failed to complete OAuth handshake with #{@name} at #{@tokenPath}. \" + response.data.error)\n\t\telse\n\t\t\treturn response.data.access_token\n\n\tgetIdentity: (accessToken) ->\n\t\tparams = {}\n\t\theaders =\n\t\t\t'User-Agent': @userAgent # http://doc.gitlab.com/ce/api/users.html#Current-user\n\n\t\tif @tokenSentVia is 'header'\n\t\t\theaders['Authorization'] = 'Bearer ' + accessToken\n\t\telse\n\t\t\tparams['access_token'] = accessToken\n\n\t\ttry\n\t\t\tresponse = HTTP.get @identityPath,\n\t\t\t\theaders: headers\n\t\t\t\tparams: params\n\n\t\t\tif response.data\n\t\t\t\treturn response.data\n\t\t\telse\n\t\t\t\treturn JSON.parse response.content\n\n\t\tcatch err\n\t\t\terror = new Error(\"Failed to fetch identity from #{@name} at #{@identityPath}. \" + err.message)\n\t\t\tthrow _.extend error, {response: err.response}\n\n\tregisterService: ->\n\t\tself = @\n\t\tOAuth.registerService @name, 2, null, (query) ->\n\t\t\taccessToken = self.getAccessToken query\n\t\t\t# console.log 'at:', accessToken\n\n\t\t\tidentity = self.getIdentity accessToken\n\n\t\t\t# Fix for Reddit\n\t\t\tif identity?.result\n\t\t\t\tidentity = identity.result\n\n\t\t\t# Fix WordPress-like identities having 'ID' instead of 'id'\n\t\t\tif identity?.ID and not identity.id\n\t\t\t\tidentity.id = identity.ID\n\n\t\t\t# Fix Auth0-like identities having 'user_id' instead of 'id'\n\t\t\tif identity?.user_id and not identity.id\n\t\t\t\tidentity.id = identity.user_id\n\n\t\t\tif identity?.CharacterID and not identity.id\n\t\t\t\tidentity.id = identity.CharacterID\n\t\t\t\n\t\t\t# Fix Dataporten having 'user.userid' instead of 'id'\n\t\t\tif identity?.user?.userid and not identity.id\n\t\t\t\tidentity.id = identity.user.userid\n\t\t\t\tidentity.email = identity.user.email\n\t\t\t\n\t\t\t# Fix general 'userid' instead of 'id' from provider\n\t\t\tif identity?.userid and not identity.id\n\t\t\t\tidentity.id = identity.userid\n\t\t\t\t\n\t\t\t# console.log 'id:', JSON.stringify identity, null, '  '\n\n\t\t\tserviceData =\n\t\t\t\t_OAuthCustom: true\n\t\t\t\taccessToken: accessToken\n\n\t\t\t_.extend serviceData, identity\n\n\t\t\tdata =\n\t\t\t\tserviceData: serviceData\n\t\t\t\toptions:\n\t\t\t\t\tprofile:\n\t\t\t\t\t\tname: identity.name or identity.username or identity.nickname or identity.CharacterName or identity.user?.name\n\n\t\t\t# console.log data\n\n\t\t\treturn data\n\n\tretrieveCredential: (credentialToken, credentialSecret) ->\n\t\treturn OAuth.retrieveCredential credentialToken, credentialSecret\n"]}