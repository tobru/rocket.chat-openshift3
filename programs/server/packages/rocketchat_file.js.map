{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat_file/file.server.coffee"],"names":[],"mappings":"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","file":"/packages/rocketchat_file.js","sourcesContent":["Grid = Npm.require('gridfs-stream')\nstream = Npm.require('stream')\nfs = Npm.require('fs')\npath = Npm.require('path')\nmkdirp = Npm.require('mkdirp')\ngm = Npm.require('gm')\nexec = Npm.require('child_process').exec\n\n# Fix problem with usernames being converted to object id\nGrid.prototype.tryParseObjectId = -> false\n\nRocketChatFile =\n\tgm: gm\n\tenabled: undefined\n\tenable: ->\n\t\tRocketChatFile.enabled = true\n\t\tRocketChat.settings.updateOptionsById 'Accounts_AvatarResize', {alert: undefined}\n\tdisable: ->\n\t\tRocketChatFile.enabled = false\n\t\tRocketChat.settings.updateOptionsById 'Accounts_AvatarResize', {alert: 'The_image_resize_will_not_work_because_we_can_not_detect_ImageMagick_or_GraphicsMagick_installed_in_your_server'}\n\n\ndetectGM = ->\n\texec 'gm version', Meteor.bindEnvironment (error, stdout, stderr) ->\n\t\tif not error? and stdout.indexOf('GraphicsMagick') > -1\n\t\t\tRocketChatFile.enable()\n\n\t\t\tRocketChat.Info.GraphicsMagick =\n\t\t\t\tenabled: true\n\t\t\t\tversion: stdout\n\t\telse\n\t\t\tRocketChat.Info.GraphicsMagick =\n\t\t\t\tenabled: false\n\n\t\texec 'convert -version', Meteor.bindEnvironment (error, stdout, stderr) ->\n\t\t\tif not error? and stdout.indexOf('ImageMagick') > -1\n\t\t\t\tif RocketChatFile.enabled isnt true\n\t\t\t\t\t# Enable GM to work with ImageMagick if no GraphicsMagick\n\t\t\t\t\tRocketChatFile.gm = RocketChatFile.gm.subClass({imageMagick: true})\n\t\t\t\t\tRocketChatFile.enable()\n\n\t\t\t\tRocketChat.Info.ImageMagick =\n\t\t\t\t\tenabled: true\n\t\t\t\t\tversion: stdout\n\t\t\telse\n\t\t\t\tif RocketChatFile.enabled isnt true\n\t\t\t\t\tRocketChatFile.disable()\n\n\t\t\t\tRocketChat.Info.ImageMagick =\n\t\t\t\t\tenabled: false\n\ndetectGM()\n\nMeteor.methods\n\t'detectGM': ->\n\t\tdetectGM()\n\t\treturn\n\n\nRocketChatFile.bufferToStream = (buffer) ->\n\tbufferStream = new stream.PassThrough()\n\tbufferStream.end buffer\n\treturn bufferStream\n\nRocketChatFile.dataURIParse = (dataURI) ->\n\timageData = dataURI.split ';base64,'\n\treturn {\n\t\timage: imageData[1]\n\t\tcontentType: imageData[0].replace('data:', '')\n\t}\n\nRocketChatFile.addPassThrough = (st, fn) ->\n\tpass = new stream.PassThrough()\n\tfn pass, st\n\treturn pass\n\n\nRocketChatFile.GridFS = class\n\tconstructor: (config={}) ->\n\t\t{name, transformWrite} = config\n\n\t\tname ?= 'file'\n\n\t\tthis.name = name\n\t\tthis.transformWrite = transformWrite\n\n\t\tmongo = Package.mongo.MongoInternals.NpmModule\n\t\tdb = Package.mongo.MongoInternals.defaultRemoteCollectionDriver().mongo.db\n\n\t\tthis.store = new Grid(db, mongo)\n\t\tthis.findOneSync = Meteor.wrapAsync this.store.collection(this.name).findOne.bind this.store.collection(this.name)\n\t\tthis.removeSync = Meteor.wrapAsync this.store.remove.bind this.store\n\n\tfindOne: (fileName) ->\n\t\treturn this.findOneSync {_id: fileName}\n\n\tremove: (fileName) ->\n\t\treturn this.removeSync\n\t\t\t_id: fileName\n\t\t\troot: this.name\n\n\tcreateWriteStream: (fileName, contentType) ->\n\t\tself = this\n\n\t\tws = this.store.createWriteStream\n\t\t\t_id: fileName\n\t\t\tfilename: fileName\n\t\t\tmode: 'w'\n\t\t\troot: this.name\n\t\t\tcontent_type: contentType\n\n\t\tif self.transformWrite?\n\t\t\tws = RocketChatFile.addPassThrough ws, (rs, ws) ->\n\t\t\t\tfile =\n\t\t\t\t\tname: self.name\n\t\t\t\t\tfileName: fileName\n\t\t\t\t\tcontentType: contentType\n\n\t\t\t\tself.transformWrite file, rs, ws\n\n\t\tws.on 'close', ->\n\t\t\tws.emit 'end'\n\n\t\treturn ws\n\n\tcreateReadStream: (fileName) ->\n\t\treturn this.store.createReadStream\n\t\t\t_id: fileName\n\t\t\troot: this.name\n\t\treturn undefined\n\n\tgetFileWithReadStream: (fileName) ->\n\t\tfile = this.findOne fileName\n\t\tif not file?\n\t\t\treturn undefined\n\n\t\trs = this.createReadStream fileName\n\n\t\treturn {\n\t\t\treadStream: rs\n\t\t\tcontentType: file.contentType\n\t\t\tlength: file.length\n\t\t\tuploadDate: file.uploadDate\n\t\t}\n\n\tdeleteFile: (fileName) ->\n\t\tfile = this.findOne fileName\n\t\tif not file?\n\t\t\treturn undefined\n\n\t\treturn this.remove fileName\n\n\nRocketChatFile.FileSystem = class\n\tconstructor: (config={}) ->\n\t\t{absolutePath, transformWrite} = config\n\n\t\tabsolutePath ?= '~/uploads'\n\n\t\tthis.transformWrite = transformWrite\n\n\t\tif absolutePath.split(path.sep)[0] is '~'\n\t\t\thomepath = process.env.HOME or process.env.HOMEPATH or process.env.USERPROFILE\n\t\t\tif homepath?\n\t\t\t\tabsolutePath = absolutePath.replace '~', homepath\n\t\t\telse\n\t\t\t\tthrow new Error('Unable to resolve \"~\" in path')\n\n\t\tthis.absolutePath = path.resolve absolutePath\n\t\tmkdirp.sync this.absolutePath\n\t\tthis.statSync = Meteor.wrapAsync fs.stat.bind fs\n\t\tthis.unlinkSync = Meteor.wrapAsync fs.unlink.bind fs\n\n\tcreateWriteStream: (fileName, contentType) ->\n\t\tself = this\n\n\t\tws = fs.createWriteStream path.join this.absolutePath, fileName\n\n\t\tif self.transformWrite?\n\t\t\tws = RocketChatFile.addPassThrough ws, (rs, ws) ->\n\t\t\t\tfile =\n\t\t\t\t\tfileName: fileName\n\t\t\t\t\tcontentType: contentType\n\n\t\t\t\tself.transformWrite file, rs, ws\n\n\t\tws.on 'close', ->\n\t\t\tws.emit 'end'\n\n\t\treturn ws\n\n\tcreateReadStream: (fileName) ->\n\t\treturn fs.createReadStream path.join this.absolutePath, fileName\n\n\tstat: (fileName) ->\n\t\treturn this.statSync path.join this.absolutePath, fileName\n\n\tremove: (fileName) ->\n\t\treturn this.unlinkSync path.join this.absolutePath, fileName\n\n\tgetFileWithReadStream: (fileName) ->\n\t\ttry\n\t\t\tstat = this.stat fileName\n\t\t\trs = this.createReadStream fileName\n\n\t\t\treturn {\n\t\t\t\treadStream: rs\n\t\t\t\t# contentType: file.contentType\n\t\t\t\tlength: stat.size\n\t\t\t}\n\t\tcatch e\n\t\t\treturn undefined\n\n\tdeleteFile: (fileName) ->\n\t\ttry\n\t\t\tstat = this.stat fileName\n\t\t\treturn this.remove fileName\n\t\tcatch e\n\t\t\treturn undefined\n"]}