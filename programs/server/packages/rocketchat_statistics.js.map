{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat_statistics/lib/rocketchat.coffee","meteor://ðŸ’»app/packages/rocketchat_statistics/server/models/Statistics.coffee","meteor://ðŸ’»app/packages/rocketchat_statistics/server/models/MRStatistics.coffee","meteor://ðŸ’»app/packages/rocketchat_statistics/server/functions/get.coffee","meteor://ðŸ’»app/packages/rocketchat_statistics/server/functions/save.coffee","meteor://ðŸ’»app/packages/rocketchat_statistics/server/methods/getStatistics.coffee"],"names":[],"mappings":"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","file":"/packages/rocketchat_statistics.js","sourcesContent":["RocketChat.statistics = {}\n","RocketChat.models.Statistics = new class extends RocketChat.models._Base\n\tconstructor: ->\n\t\t@_initModel 'statistics'\n\n\t\t@tryEnsureIndex { 'createdAt': 1 }\n\n\t# FIND ONE\n\tfindOneById: (_id, options) ->\n\t\tquery =\n\t\t\t_id: _id\n\n\t\treturn @findOne query, options\n\n\tfindLast: ->\n\t\toptions =\n\t\t\tsort:\n\t\t\t\tcreatedAt: -1\n\t\t\tlimit: 1\n\t\treturn @find({}, options).fetch()?[0]\n","RocketChat.models.MRStatistics = new class extends RocketChat.models._Base\n\tconstructor: ->\n\t\t@_initModel 'mr_statistics'\n\n\n\t# FIND ONE\n\tfindOneById: (_id, options) ->\n\t\tquery =\n\t\t\t_id: _id\n\n\t\treturn @findOne query, options\n","RocketChat.statistics.get = ->\n\tstatistics = {}\n\n\t# Version\n\tstatistics.uniqueId = RocketChat.settings.get(\"uniqueID\")\n\tstatistics.createdAt = RocketChat.models.Settings.findOne(\"uniqueID\")?._createdAt\n\tstatistics.version = RocketChat.Info?.version\n\tstatistics.tag = RocketChat.Info?.tag\n\tstatistics.branch = RocketChat.Info?.branch\n\n\t# User statistics\n\tstatistics.totalUsers = Meteor.users.find().count()\n\tstatistics.activeUsers = Meteor.users.find({ active: true }).count()\n\tstatistics.nonActiveUsers = statistics.totalUsers - statistics.activeUsers\n\tstatistics.onlineUsers = Meteor.users.find({ statusConnection: 'online' }).count()\n\tstatistics.awayUsers = Meteor.users.find({ statusConnection: 'away' }).count()\n\tstatistics.offlineUsers = statistics.totalUsers - statistics.onlineUsers - statistics.awayUsers\n\n\t# Room statistics\n\tstatistics.totalRooms = RocketChat.models.Rooms.find().count()\n\tstatistics.totalChannels = RocketChat.models.Rooms.findByType('c').count()\n\tstatistics.totalPrivateGroups = RocketChat.models.Rooms.findByType('p').count()\n\tstatistics.totalDirect = RocketChat.models.Rooms.findByType('d').count()\n\n\t# Message statistics\n\tstatistics.totalMessages = RocketChat.models.Messages.find().count()\n\n\tm = ->\n\t\temit 1,\n\t\t\tsum: this.usernames.length or 0\n\t\t\tmin: this.usernames.length or 0\n\t\t\tmax: this.usernames.length or 0\n\t\t\tcount: 1\n\n\t\temit this.t,\n\t\t\tsum: this.usernames.length or 0\n\t\t\tmin: this.usernames.length or 0\n\t\t\tmax: this.usernames.length or 0\n\t\t\tcount: 1\n\n\tr = (k, v) ->\n\t\ta = v.shift()\n\t\tfor b in v\n\t\t\ta.sum += b.sum\n\t\t\ta.min = Math.min a.min, b.min\n\t\t\ta.max = Math.max a.max, b.max\n\t\t\ta.count += b.count\n\t\treturn a\n\n\tf = (k, v) ->\n\t\tv.avg = v.sum / v.count\n\t\treturn v\n\n\tresult = RocketChat.models.Rooms.model.mapReduce(m, r, { finalize: f, out: \"rocketchat_mr_statistics\" })\n\n\tstatistics.maxRoomUsers = 0\n\tstatistics.avgChannelUsers = 0\n\tstatistics.avgPrivateGroupUsers = 0\n\n\tif RocketChat.models.MRStatistics.findOneById(1)\n\t\tstatistics.maxRoomUsers = RocketChat.models.MRStatistics.findOneById(1).value.max\n\n\tif RocketChat.models.MRStatistics.findOneById('c')\n\t\tstatistics.avgChannelUsers = RocketChat.models.MRStatistics.findOneById('c').value.avg\n\n\tif RocketChat.models.MRStatistics.findOneById('p')\n\t\tstatistics.avgPrivateGroupUsers = RocketChat.models.MRStatistics.findOneById('p').value.avg\n\n\tstatistics.lastLogin = RocketChat.models.Users.getLastLogin()\n\tstatistics.lastMessageSentAt = RocketChat.models.Messages.getLastTimestamp()\n\tstatistics.lastSeenSubscription = RocketChat.models.Subscriptions.getLastSeen()\n\n\tmigration = Migrations?._getControl()\n\tif migration\n\t\tstatistics.migration = _.pick(migration, 'version', 'locked')\n\n\tos = Npm.require('os')\n\tstatistics.os =\n\t\ttype: os.type()\n\t\tplatform: os.platform()\n\t\tarch: os.arch()\n\t\trelease: os.release()\n\t\tuptime: os.uptime()\n\t\tloadavg: os.loadavg()\n\t\ttotalmem: os.totalmem()\n\t\tfreemem: os.freemem()\n\t\tcpus: os.cpus()\n\n\tstatistics.process =\n\t\tnodeVersion: process.version\n\t\tpid: process.pid\n\t\tuptime: process.uptime()\n\n\tstatistics.migration = RocketChat.Migrations._getControl()\n\n\tstatistics.instanceCount = InstanceStatus.getCollection().find().count()\n\n\treturn statistics\n","RocketChat.statistics.save = ->\n\tstatistics = RocketChat.statistics.get()\n\tstatistics.createdAt = new Date\n\tRocketChat.models.Statistics.insert statistics\n\treturn statistics\n\n","Meteor.methods\n\tgetStatistics: (refresh) ->\n\t\tif not Meteor.userId()\n\t\t\tthrow new Meteor.Error('error-invalid-user', \"Invalid user\", { method: 'getStatistics' })\n\n\t\tunless RocketChat.authz.hasPermission(Meteor.userId(), 'view-statistics') is true\n\t\t\tthrow new Meteor.Error('error-not-allowed', \"Not allowed\", { method: 'getStatistics' })\n\n\t\tif refresh\n\t\t\treturn RocketChat.statistics.save()\n\t\telse\n\t\t\treturn RocketChat.models.Statistics.findLast()\n\n"]}