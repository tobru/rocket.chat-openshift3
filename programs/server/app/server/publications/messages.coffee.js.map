{"version":3,"sources":["meteor://ðŸ’»app/server/publications/messages.coffee"],"names":[],"mappings":";;;;;;;;;AAAA,MAAM,CAAC,OAAP,CAAe,UAAf,EAA2B,SAAC,GAAD,EAAM,KAAN;AAC1B;AAAA,WAAW,CAAC,MAAZ;AACC,WAAO,IAAI,CAAC,KAAL,EAAP,CADD;GAAA;AAAA,EAGA,cAAc,IAHd;AAKA,MAAG,eAAgB,QAAnB;AACC,WAAO,IAAI,CAAC,KAAL,EAAP,CADD;GALA;AAQA,MAAG,OAAU,CAAC,IAAP,CAAY,eAAZ,EAA6B,GAA7B,EAAkC,IAAI,CAAC,MAAvC,CAAP;AACC,WAAO,IAAI,CAAC,KAAL,EAAP,CADD;GARA;AAAA,EAWA,SAAS,UAAU,CAAC,MAAM,CAAC,QAAQ,CAAC,mBAA3B,CAA+C,GAA/C,EACR;AAAA,UACC;AAAA,UAAI,EAAJ;KADD;AAAA,IAEA,OAAO,EAFP;GADQ,CAXT;AAAA,EAgBA,eAAe,MAAM,CAAC,cAAP,CACd;AAAA,WAAO,SAAC,GAAD,EAAM,MAAN;AACN,YAAM,CAAC,OAAP,GAAiB,CAAC,CAAC,SAAF,CAAY,MAAM,CAAC,OAAnB,EAA4B;AAAA,QAAE,KAAK,WAAW,CAAC,MAAnB;OAA5B,CAAjB;aACA,WAAW,CAAC,KAAZ,CAAkB,oBAAlB,EAAwC,GAAxC,EAA6C,MAA7C,EAFM;IAAA,CAAP;AAAA,IAIA,SAAS,SAAC,GAAD,EAAM,MAAN;AACR,YAAM,CAAC,OAAP,GAAiB,CAAC,CAAC,SAAF,CAAY,MAAM,CAAC,OAAnB,EAA4B;AAAA,QAAE,KAAK,WAAW,CAAC,MAAnB;OAA5B,CAAjB;aACA,WAAW,CAAC,OAAZ,CAAoB,oBAApB,EAA0C,GAA1C,EAA+C,MAA/C,EAFQ;IAAA,CAJT;GADc,CAhBf;AAAA,EAyBA,eAAe,UAAU,CAAC,MAAM,CAAC,QAAQ,CAAC,qBAA3B,CAAiD,GAAjD,EACd;AAAA,YACC;AAAA,WAAK,CAAL;KADD;GADc,CAzBf;AAAA,EA6BA,qBAAqB,YAAY,CAAC,cAAb,CACpB;AAAA,WAAO,SAAC,GAAD,EAAM,MAAN;aACN,WAAW,CAAC,KAAZ,CAAkB,oBAAlB,EAAwC,GAAxC,EAA6C;AAAA,QAAC,SAAS,IAAV;OAA7C,EADM;IAAA,CAAP;AAAA,IAEA,SAAS,SAAC,GAAD,EAAM,MAAN;aACR,WAAW,CAAC,KAAZ,CAAkB,oBAAlB,EAAwC,GAAxC,EAA6C;AAAA,QAAC,SAAS,IAAV;OAA7C,EADQ;IAAA,CAFT;GADoB,CA7BrB;AAAA,EAmCA,IAAC,MAAD,EAnCA;SAoCA,IAAC,OAAD,CAAQ;AACP,gBAAY,CAAC,IAAb;WACA,kBAAkB,CAAC,IAAnB,GAFO;EAAA,CAAR,EArC0B;AAAA,CAA3B","file":"/server/publications/messages.coffee.js","sourcesContent":["Meteor.publish 'messages', (rid, start) ->\n\tunless this.userId\n\t\treturn this.ready()\n\n\tpublication = this\n\n\tif typeof rid isnt 'string'\n\t\treturn this.ready()\n\n\tif not Meteor.call 'canAccessRoom', rid, this.userId\n\t\treturn this.ready()\n\n\tcursor = RocketChat.models.Messages.findVisibleByRoomId rid,\n\t\tsort:\n\t\t\tts: -1\n\t\tlimit: 50\n\n\tcursorHandle = cursor.observeChanges\n\t\tadded: (_id, record) ->\n\t\t\trecord.starred = _.findWhere record.starred, { _id: publication.userId }\n\t\t\tpublication.added('rocketchat_message', _id, record)\n\n\t\tchanged: (_id, record) ->\n\t\t\trecord.starred = _.findWhere record.starred, { _id: publication.userId }\n\t\t\tpublication.changed('rocketchat_message', _id, record)\n\n\tcursorDelete = RocketChat.models.Messages.findInvisibleByRoomId rid,\n\t\tfields:\n\t\t\t_id: 1\n\n\tcursorDeleteHandle = cursorDelete.observeChanges\n\t\tadded: (_id, record) ->\n\t\t\tpublication.added('rocketchat_message', _id, {_hidden: true})\n\t\tchanged: (_id, record) ->\n\t\t\tpublication.added('rocketchat_message', _id, {_hidden: true})\n\n\t@ready()\n\t@onStop ->\n\t\tcursorHandle.stop()\n\t\tcursorDeleteHandle.stop()\n"]}