{"version":3,"sources":["meteor://ðŸ’»app/server/startup/initialData.coffee"],"names":[],"mappings":"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","file":"/server/startup/initialData.coffee.js","sourcesContent":["Meteor.startup ->\n\tMeteor.defer ->\n\n\t\tif not RocketChat.models.Rooms.findOneById('GENERAL')?\n\t\t\tRocketChat.models.Rooms.createWithIdTypeAndName 'GENERAL', 'c', 'general',\n\t\t\t\tdefault: true\n\n\t\tif not RocketChat.models.Users.findOneById('rocket.cat')?\n\t\t\tRocketChat.models.Users.create\n\t\t\t\t_id: 'rocket.cat'\n\t\t\t\tname: \"Rocket.Cat\"\n\t\t\t\tusername: 'rocket.cat'\n\t\t\t\tstatus: \"online\"\n\t\t\t\tstatusDefault: \"online\"\n\t\t\t\tutcOffset: 0\n\t\t\t\tactive: true\n\t\t\t\ttype: 'bot'\n\n\t\t\tRocketChat.authz.addUserRoles('rocket.cat', 'bot')\n\n\t\t\trs = RocketChatFile.bufferToStream new Buffer(Assets.getBinary('avatars/rocketcat.png'), 'utf8')\n\t\t\tRocketChatFileAvatarInstance.deleteFile \"rocket.cat.jpg\"\n\t\t\tws = RocketChatFileAvatarInstance.createWriteStream \"rocket.cat.jpg\", 'image/png'\n\t\t\tws.on 'end', Meteor.bindEnvironment ->\n\t\t\t\tRocketChat.models.Users.setAvatarOrigin 'rocket.cat', 'local'\n\n\t\t\trs.pipe(ws)\n\n\n\t\tif process.env.ADMIN_PASS?\n\t\t\tif _.isEmpty(RocketChat.authz.getUsersInRole( 'admin' ).fetch())\n\t\t\t\tconsole.log 'Inserting admin user:'.green\n\n\t\t\t\tadminUser =\n\t\t\t\t\tname: \"Administrator\"\n\t\t\t\t\tusername: \"admin\"\n\t\t\t\t\tstatus: \"offline\"\n\t\t\t\t\tstatusDefault: \"online\"\n\t\t\t\t\tutcOffset: 0\n\t\t\t\t\tactive: true\n\n\t\t\t\tif process.env.ADMIN_NAME?\n\t\t\t\t\tadminUser.name = process.env.ADMIN_NAME\n\t\t\t\tconsole.log \"Name: #{adminUser.name}\".green\n\n\t\t\t\tif process.env.ADMIN_EMAIL?\n\t\t\t\t\tre = /^[^@].*@[^@]+$/i\n\t\t\t\t\tif re.test process.env.ADMIN_EMAIL\n\t\t\t\t\t\tif not RocketChat.models.Users.findOneByEmailAddress process.env.ADMIN_EMAIL\n\t\t\t\t\t\t\tadminUser.emails = [\n\t\t\t\t\t\t\t\taddress: process.env.ADMIN_EMAIL\n\t\t\t\t\t\t\t\tverified: true\n\t\t\t\t\t\t\t]\n\t\t\t\t\t\t\tconsole.log \"Email: #{process.env.ADMIN_EMAIL}\".green\n\t\t\t\t\t\telse\n\t\t\t\t\t\t\tconsole.log 'Email provided already exists; Ignoring environment variables ADMIN_EMAIL'.red\n\t\t\t\t\telse\n\t\t\t\t\t\tconsole.log 'Email provided is invalid; Ignoring environment variables ADMIN_EMAIL'.red\n\n\t\t\t\tif process.env.ADMIN_USERNAME?\n\t\t\t\t\ttry\n\t\t\t\t\t\tnameValidation = new RegExp '^' + RocketChat.settings.get('UTF8_Names_Validation') + '$'\n\t\t\t\t\tcatch\n\t\t\t\t\t\tnameValidation = new RegExp '^[0-9a-zA-Z-_.]+$'\n\t\t\t\t\tif nameValidation.test process.env.ADMIN_USERNAME\n\t\t\t\t\t\tif RocketChat.checkUsernameAvailability(process.env.ADMIN_USERNAME)\n\t\t\t\t\t\t\tadminUser.username = process.env.ADMIN_USERNAME\n\t\t\t\t\t\telse\n\t\t\t\t\t\t\tconsole.log 'Username provided already exists; Ignoring environment variables ADMIN_USERNAME'.red\n\t\t\t\t\telse\n\t\t\t\t\t\tconsole.log 'Username provided is invalid; Ignoring environment variables ADMIN_USERNAME'.red\n\t\t\t\tconsole.log \"Username: #{adminUser.username}\".green\n\n\t\t\t\tadminUser.type = 'user'\n\n\t\t\t\tid = RocketChat.models.Users.create adminUser\n\n\t\t\t\tAccounts.setPassword id, process.env.ADMIN_PASS\n\t\t\t\tconsole.log \"Password: #{process.env.ADMIN_PASS}\".green\n\t\t\t\tRocketChat.authz.addUserRoles( id, 'admin')\n\n\t\t\telse\n\t\t\t\tconsole.log 'Users with admin role already exist; Ignoring environment variables ADMIN_PASS'.red\n\n\t\t# Set oldest user as admin, if none exists yet\n\t\tif _.isEmpty( RocketChat.authz.getUsersInRole( 'admin' ).fetch())\n\t\t\t# get oldest user\n\t\t\toldestUser = RocketChat.models.Users.findOne({ _id: { $ne: 'rocket.cat' }}, { fields: { username: 1 }, sort: {createdAt: 1}})\n\t\t\tif oldestUser\n\t\t\t\tRocketChat.authz.addUserRoles( oldestUser._id, 'admin')\n\t\t\t\tconsole.log \"No admins are found. Set #{oldestUser.username} as admin for being the oldest user\"\n"]}