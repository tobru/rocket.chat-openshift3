{"version":3,"sources":["meteor://ðŸ’»app/server/startup/migrations/v003.coffee"],"names":[],"mappings":"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","file":"/server/startup/migrations/v003.coffee.js","sourcesContent":["RocketChat.Migrations.add\n\tversion: 3\n\tup: ->\n\n\n\t\tRocketChat.models.Subscriptions.tryDropIndex 'uid_1'\n\t\tRocketChat.models.Subscriptions.tryDropIndex 'rid_1_uid_1'\n\n\n\t\tconsole.log 'Fixing ChatSubscription uid'\n\t\tRocketChat.models.Subscriptions.find({uid: {$exists: true}}, {nonreactive: true}).forEach (sub) ->\n\t\t\tupdate = {}\n\t\t\tuser = RocketChat.models.Users.findOneById(sub.uid, {fields: {username: 1}})\n\t\t\tif user?\n\t\t\t\tupdate.$set ?= {}\n\t\t\t\tupdate.$unset ?= {}\n\t\t\t\tupdate.$set['u._id'] = user._id\n\t\t\t\tupdate.$set['u.username'] = user.username\n\t\t\t\tupdate.$unset.uid = 1\n\n\t\t\tif Object.keys(update).length > 0\n\t\t\t\tRocketChat.models.Subscriptions.update(sub._id, update)\n\n\n\t\tconsole.log 'Fixing ChatRoom uids'\n\t\tRocketChat.models.Rooms.find({'uids.0': {$exists: true}}, {nonreactive: true}).forEach (room) ->\n\t\t\tupdate = {}\n\t\t\tusers = RocketChat.models.Users.find {_id: {$in: room.uids}, username: {$exists: true}}, {fields: {username: 1}}\n\t\t\tusernames = users.map (user) ->\n\t\t\t\treturn user.username\n\n\t\t\tupdate.$set ?= {}\n\t\t\tupdate.$unset ?= {}\n\t\t\tupdate.$set.usernames = usernames\n\t\t\tupdate.$unset.uids = 1\n\n\t\t\tuser = RocketChat.models.Users.findOneById(room.uid, {fields: {username: 1}})\n\t\t\tif user?\n\t\t\t\tupdate.$set['u._id'] = user._id\n\t\t\t\tupdate.$set['u.username'] = user.username\n\t\t\t\tupdate.$unset.uid = 1\n\n\t\t\tif room.t is 'd' and usernames.length is 2\n\t\t\t\tfor k, v of update.$set\n\t\t\t\t\troom[k] = v\n\t\t\t\tfor k, v of update.$unset\n\t\t\t\t\tdelete room[k]\n\n\t\t\t\toldId = room._id\n\t\t\t\troom._id = usernames.sort().join(',')\n\t\t\t\tRocketChat.models.Rooms.insert(room)\n\t\t\t\tRocketChat.models.Rooms.removeById(oldId)\n\t\t\t\tRocketChat.models.Subscriptions.update({rid: oldId}, {$set: {rid: room._id}}, {multi: true})\n\t\t\t\tRocketChat.models.Messages.update({rid: oldId}, {$set: {rid: room._id}}, {multi: true})\n\t\t\telse\n\t\t\t\tRocketChat.models.Rooms.update(room._id, update)\n\n\n\t\tconsole.log 'Fixing ChatMessage uid'\n\t\tRocketChat.models.Messages.find({uid: {$exists: true}}, {nonreactive: true}).forEach (message) ->\n\t\t\tupdate = {}\n\t\t\tuser = RocketChat.models.Users.findOneById(message.uid, {fields: {username: 1}})\n\t\t\tif user?\n\t\t\t\tupdate.$set ?= {}\n\t\t\t\tupdate.$unset ?= {}\n\t\t\t\tupdate.$set['u._id'] = user._id\n\t\t\t\tupdate.$set['u.username'] = user.username\n\t\t\t\tupdate.$unset.uid = 1\n\n\t\t\tif Object.keys(update).length > 0\n\t\t\t\tRocketChat.models.Messages.update(message._id, update)\n\n\t\tconsole.log 'End'\n"]}