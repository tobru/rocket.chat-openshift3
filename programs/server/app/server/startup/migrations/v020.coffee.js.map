{"version":3,"sources":["meteor://ðŸ’»app/server/startup/migrations/v020.coffee"],"names":[],"mappings":";;;;;;;;;AAAA,UAAU,CAAC,UAAU,CAAC,GAAtB,CACC;AAAA,WAAS,EAAT;AAAA,EACA,IAAI;AACH;AAAA;;;;OAAA;AAAA;AAAA,IAOA,WACC;AAAA,WAAK;AAAA,QAAE,SAAS,IAAX;OAAL;AAAA,MACA,YAAY;AAAA,QAAE,SAAS,IAAX;OADZ;KARD;AAAA,IAUA,aACC;AAAA,cACC;AAAA,aAAK,CAAL;AAAA,QACA,KAAK,CADL;AAAA,QAEA,YAAY,CAFZ;OADD;KAXD;AAAA,IAeA,qBAAqB,UAAU,CAAC,MAAM,CAAC,QAAQ,CAAC,IAA3B,CAAgC,QAAhC,EAA0C,UAA1C,CAfrB;AAgBA,2BAAgC,CAAC,KAAnB,EAAd;AAAA;KAhBA;AAAA,IAkBA,CAAC,CAAC,IAAF,CAAQ,kBAAkB,CAAC,KAAnB,EAAR,EAAoC,SAAC,GAAD;AACnC;aAAA,UAAU,CAAC,MAAM,CAAC,OAAO,CAAC,MAA1B,CAAiC;AAAA,QAAE,iDAAc,CAAE,qBAAlB;OAAjC,EAA0D;AAAA,QAAE,MAAM;AAAA,UAAE,KAAK,GAAG,CAAC,GAAX;SAAR;OAA1D,EAAsF;AAAA,QAAE,QAAQ,IAAV;OAAtF,EADmC;IAAA,CAApC,CAlBA;WAsBA,OAAO,CAAC,GAAR,CAAY,sFAAZ,EAvBG;EAAA,CADJ;CADD","file":"/server/startup/migrations/v020.coffee.js","sourcesContent":["RocketChat.Migrations.add\n\tversion: 20\n\tup: ->\n\t\t###\n\t\t# Migrate existing `rocketchat_uploads` documents to include the room Id\n\t\t# where the file was uploaded to. The room Id is retrieved from the message\n\t\t# document created after the file upload.\n\t\t###\n\n\t\t# list of channel messages which were created after uploading a file\n\t\tmsgQuery =\n\t\t\trid: { $exists: true }\n\t\t\t'file._id': { $exists: true }\n\t\tmsgOptions =\n\t\t\tfields:\n\t\t\t\t_id: 1\n\t\t\t\trid: 1\n\t\t\t\t'file._id': 1\n\t\tcursorFileMessages = RocketChat.models.Messages.find(msgQuery, msgOptions);\n\t\treturn unless cursorFileMessages.count()\n\n\t\t_.each( cursorFileMessages.fetch(), (msg) ->\n\t\t\tRocketChat.models.Uploads.update({ _id: msg?.file?._id }, { $set: { rid: msg.rid } }, { $multi: true })\n\t\t)\n\n\t\tconsole.log 'Updated rocketchat_uploads documents to include the room Id in which they were sent.'\n"]}