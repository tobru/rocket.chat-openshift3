{"version":3,"sources":["meteor://ðŸ’»app/server/startup/migrations/v005.coffee"],"names":[],"mappings":"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","file":"/server/startup/migrations/v005.coffee.js","sourcesContent":["RocketChat.Migrations.add\n\tversion: 5\n\tup: ->\n\n\t\tconsole.log 'Dropping test rooms with less than 2 messages'\n\t\tRocketChat.models.Rooms.find({msgs: {'$lt': 2}}).forEach (room) ->\n\t\t\tconsole.log 'Dropped: ', room.name\n\t\t\tRocketChat.models.Rooms.removeById room._id\n\t\t\tRocketChat.models.Messages.removeByRoomId room._id\n\t\t\tRocketChat.models.Subscriptions.removeByRoomId room._id\n\n\n\t\tconsole.log 'Dropping test rooms with less than 2 user'\n\t\tRocketChat.models.Rooms.find({usernames: {'$size':1}}).forEach (room) ->\n\t\t\tconsole.log 'Dropped: ', room.name\n\t\t\tRocketChat.models.Rooms.removeById room._id\n\t\t\tRocketChat.models.Messages.removeByRoomId room._id\n\t\t\tRocketChat.models.Subscriptions.removeByRoomId room._id\n\n\n\t\tconsole.log 'Adding username to all users'\n\t\tRocketChat.models.Users.find({ 'username': {'$exists':0}, 'emails': {'$exists':1} }).forEach (user) ->\n\t\t\tnewUserName = user.emails[0].address.split(\"@\")[0]\n\t\t\tif RocketChat.models.Users.findOneByUsername(newUserName)\n\t\t\t\tnewUserName = newUserName + Math.floor((Math.random() * 10) + 1)\n\t\t\t\tif RocketChat.models.Users.findOneByUsername(newUserName)\n\t\t\t\t\tnewUserName = newUserName + Math.floor((Math.random() * 10) + 1)\n\t\t\t\t\tif RocketChat.models.Users.findOneByUsername(newUserName)\n\t\t\t\t\t\tnewUserName = newUserName + Math.floor((Math.random() * 10) + 1);\n\t\t\tconsole.log 'Adding: username ' + newUserName + ' to all user ' + user._id;\n\t\t\tRocketChat.models.Users.setUsername user._id, newUserName\n\n\n\t\tconsole.log 'Fixing _id of direct messages rooms'\n\t\tRocketChat.models.Rooms.findByType('d').forEach (room) ->\n\t\t\tnewId = ''\n\t\t\tid0 = RocketChat.models.Users.findOneByUsername(room.usernames[0])._id\n\t\t\tid1 = RocketChat.models.Users.findOneByUsername(room.usernames[1])._id\n\t\t\tids = [id0,id1]\n\t\t\tnewId = ids.sort().join('')\n\t\t\tif (newId != room._id)\n\t\t\t\tconsole.log 'Fixing: _id ' + room._id + ' to ' + newId\n\t\t\t\tRocketChat.models.Subscriptions.update({'rid':room._id},{'$set':{'rid':newId}},{'multi':1})\n\t\t\t\tRocketChat.models.Messages.update({'rid':room._id},{'$set':{'rid':newId}},{'multi':1})\n\t\t\t\tRocketChat.models.Rooms.removeById(room._id)\n\t\t\t\troom._id = newId\n\t\t\t\tRocketChat.models.Rooms.insert(room)\n\t\t\tRocketChat.models.Subscriptions.update({'rid':room._id,'u._id':id0},{'$set':{'name':room.usernames[1]}})\n\t\t\tRocketChat.models.Subscriptions.update({'rid':room._id,'u._id':id1},{'$set':{'name':room.usernames[0]}})\n\n\n\t\tconsole.log 'Adding u.username to all documents'\n\t\tRocketChat.models.Users.find({},{'username':1}).forEach (user) ->\n\t\t\tconsole.log 'Adding: u.username ' + user.username + ' to all document'\n\t\t\tRocketChat.models.Rooms.update({'u._id':user._id},{'$set':{'u.username':user.username}},{'multi':1})\n\t\t\tRocketChat.models.Subscriptions.update({'u._id':user._id},{'$set':{'u.username':user.username}},{'multi':1})\n\t\t\tRocketChat.models.Messages.update({'u._id':user._id},{'$set':{'u.username':user.username}},{'multi':1})\n\t\t\tRocketChat.models.Messages.update({'uid':user._id},{'$set':{'u':user}},{'multi':1})\n\t\t\tRocketChat.models.Messages.update({'by':user._id},{'$set':{'u':user}},{'multi':1})\n\t\t\tRocketChat.models.Messages.update({'uid':{'$exists':1}},{'$unset':{'uid':1,'by':1}},{'multi':1})\n\n\n\t\tconsole.log 'End'\n"]}