{"version":3,"sources":["meteor://ðŸ’»app/server/startup/migrations/v015.coffee"],"names":[],"mappings":"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","file":"/server/startup/migrations/v015.coffee.js","sourcesContent":["RocketChat.Migrations.add\n\tversion: 15\n\tup: ->\n\n\t\tconsole.log 'Starting file migration'\n\t\toldFilesCollection  = new Meteor.Collection 'cfs.Files.filerecord'\n\t\toldGridFSCollection = new Meteor.Collection 'cfs_gridfs.files.files'\n\t\toldChunkCollection  = new Meteor.Collection 'cfs_gridfs.files.chunks'\n\n\t\tnewFilesCollection  = RocketChat.models.Uploads\n\t\tnewGridFSCollection = new Meteor.Collection 'rocketchat_uploads.files'\n\t\tnewChunkCollection  = new Meteor.Collection 'rocketchat_uploads.chunks'\n\n\n\t\toldFilesCollection.find({'copies.files.key': {$exists: true}}).forEach (cfsRecord) ->\n\t\t\tnameParts = cfsRecord.original.name?.split('.')\n\t\t\textension = ''\n\t\t\turl = \"ufs/rocketchat_uploads/#{cfsRecord._id}\"\n\n\t\t\tconsole.log 'migrating file', url\n\n\t\t\tif nameParts?.length > 1\n\t\t\t\textension = nameParts.pop()\n\t\t\t\turl = url + '.' + extension\n\n\t\t\trecord =\n\t\t\t\t_id: cfsRecord._id\n\t\t\t\tname: cfsRecord.original.name or ''\n\t\t\t\tsize: cfsRecord.original.size\n\t\t\t\ttype: cfsRecord.original.type\n\t\t\t\tcomplete: true\n\t\t\t\tuploading: false\n\t\t\t\tstore: \"rocketchat_uploads\"\n\t\t\t\textension: extension\n\t\t\t\tuserId: cfsRecord.userId\n\t\t\t\tuploadedAt: cfsRecord.updatedAt\n\t\t\t\turl: Meteor.absoluteUrl() + url\n\n\t\t\tnewFilesCollection.insert record\n\n\t\t\toldGridFsFile = oldGridFSCollection.findOne({_id: new Meteor.Collection.ObjectID(cfsRecord.copies.files.key)})\n\n\t\t\tnewGridFSCollection.insert\n\t\t\t\t_id: cfsRecord._id\n\t\t\t\tfilename: cfsRecord._id\n\t\t\t\tcontentType: oldGridFsFile.contentType\n\t\t\t\tlength: oldGridFsFile.length\n\t\t\t\tchunkSize: oldGridFsFile.chunkSize\n\t\t\t\tuploadDate: oldGridFsFile.uploadDate\n\t\t\t\taliases: null\n\t\t\t\tmetadata: null\n\t\t\t\tmd5: oldGridFsFile.md5\n\n\t\t\toldChunkCollection.find({files_id: new Meteor.Collection.ObjectID(cfsRecord.copies.files.key)}).forEach (oldChunk) ->\n\t\t\t\tnewChunkCollection.insert\n\t\t\t\t\t_id: oldChunk._id\n\t\t\t\t\tfiles_id: cfsRecord._id\n\t\t\t\t\tn: oldChunk.n\n\t\t\t\t\tdata: oldChunk.data\n\n\t\t\tRocketChat.models.Messages.find({$or: [{ 'urls.url': \"https://demo.rocket.chat/cfs/files/Files/#{cfsRecord._id}\" }, { 'urls.url': \"https://rocket.chat/cfs/files/Files/#{cfsRecord._id}\" }]}).forEach (message) ->\n\t\t\t\tfor urlsItem in message.urls\n\t\t\t\t\tif urlsItem.url is \"https://demo.rocket.chat/cfs/files/Files/#{cfsRecord._id}\" or urlsItem.url is \"https://rocket.chat/cfs/files/Files/#{cfsRecord._id}\"\n\t\t\t\t\t\turlsItem.url = Meteor.absoluteUrl() + url\n\t\t\t\t\t\tif urlsItem.parsedUrl?.pathname?\n\t\t\t\t\t\t\turlsItem.parsedUrl.pathname = \"/#{url}\"\n\t\t\t\t\t\tmessage.msg = message.msg.replace \"https://demo.rocket.chat/cfs/files/Files/#{cfsRecord._id}\", Meteor.absoluteUrl() + url\n\t\t\t\t\t\tmessage.msg = message.msg.replace \"https://rocket.chat/cfs/files/Files/#{cfsRecord._id}\", Meteor.absoluteUrl() + url\n\n\t\t\t\tRocketChat.models.Messages.update {_id: message._id}, {$set: {urls: message.urls, msg: message.msg}}\n\n\t\t\toldFilesCollection.remove  _id: cfsRecord._id\n\t\t\toldGridFSCollection.remove _id: oldGridFsFile._id\n\t\t\toldChunkCollection.remove  files_id: new Meteor.Collection.ObjectID(cfsRecord.copies.files.key)\n\n\t\tconsole.log 'End of file migration'\n"]}