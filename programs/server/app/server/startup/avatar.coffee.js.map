{"version":3,"sources":["meteor://ðŸ’»app/server/startup/avatar.coffee"],"names":[],"mappings":"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","file":"/server/startup/avatar.coffee.js","sourcesContent":["Meteor.startup ->\n\tstoreType = 'GridFS'\n\n\tif RocketChat.settings.get 'Accounts_AvatarStoreType'\n\t\tstoreType = RocketChat.settings.get 'Accounts_AvatarStoreType'\n\n\tRocketChatStore = RocketChatFile[storeType]\n\n\tif not RocketChatStore?\n\t\tthrow new Error \"Invalid RocketChatStore type [#{storeType}]\"\n\n\tconsole.log \"Using #{storeType} for Avatar storage\".green\n\n\ttransformWrite = (file, readStream, writeStream) ->\n\t\tif RocketChatFile.enabled is false or RocketChat.settings.get('Accounts_AvatarResize') isnt true\n\t\t\treturn readStream.pipe writeStream\n\n\t\theight = RocketChat.settings.get 'Accounts_AvatarSize'\n\t\twidth = height\n\n\t\tRocketChatFile.gm(readStream, file.fileName).background('#ffffff').resize(width, height+'^>').gravity('Center').extent(width, height).stream('jpeg').pipe(writeStream)\n\n\tpath = \"~/uploads\"\n\n\tif RocketChat.settings.get('Accounts_AvatarStorePath')?.trim() isnt ''\n\t\tpath = RocketChat.settings.get 'Accounts_AvatarStorePath'\n\n\t@RocketChatFileAvatarInstance = new RocketChatStore\n\t\tname: 'avatars'\n\t\tabsolutePath: path\n\t\ttransformWrite: transformWrite\n\n\tWebApp.connectHandlers.use '/avatar/', Meteor.bindEnvironment (req, res, next) ->\n\t\tparams =\n\t\t\tusername: decodeURIComponent(req.url.replace(/^\\//, '').replace(/\\?.*$/, ''))\n\n\t\tif _.isEmpty params.username\n\t\t\tres.writeHead 403\n\t\t\tres.write 'Forbidden'\n\t\t\tres.end()\n\t\t\treturn\n\n\t\tif params.username[0] isnt '@'\n\t\t\tif Meteor.settings?.public?.sandstorm\n\t\t\t\tuser = RocketChat.models.Users.findOneByUsername(params.username.replace('.jpg', ''))\n\t\t\t\tif user?.services?.sandstorm?.picture\n\t\t\t\t\tres.setHeader 'Location', user.services.sandstorm.picture\n\t\t\t\t\tres.writeHead 302\n\t\t\t\t\tres.end()\n\t\t\t\t\treturn\n\t\t\tfile = RocketChatFileAvatarInstance.getFileWithReadStream encodeURIComponent(params.username)\n\t\telse\n\t\t\tparams.username = params.username.replace '@', ''\n\n\t\t#console.log \"[avatar] checking username #{@params.username} (derrived from path #{req.url})\"\n\t\tres.setHeader 'Content-Disposition', 'inline'\n\n\t\tif not file?\n\t\t\tres.setHeader 'Content-Type', 'image/svg+xml'\n\t\t\tres.setHeader 'Cache-Control', 'public, max-age=0'\n\t\t\tres.setHeader 'Expires', '-1'\n\t\t\tres.setHeader 'Last-Modified', \"Thu, 01 Jan 2015 00:00:00 GMT\"\n\n\t\t\treqModifiedHeader = req.headers[\"if-modified-since\"];\n\t\t\tif reqModifiedHeader?\n\t\t\t\tif reqModifiedHeader is \"Thu, 01 Jan 2015 00:00:00 GMT\"\n\t\t\t\t\tres.writeHead 304\n\t\t\t\t\tres.end()\n\t\t\t\t\treturn\n\n\t\t\tcolors = ['#F44336','#E91E63','#9C27B0','#673AB7','#3F51B5','#2196F3','#03A9F4','#00BCD4','#009688','#4CAF50','#8BC34A','#CDDC39','#FFC107','#FF9800','#FF5722','#795548','#9E9E9E','#607D8B']\n\n\t\t\tusername = params.username.replace('.jpg', '')\n\t\t\tcolor = ''\n\t\t\tinitials = ''\n\t\t\tif username is \"?\"\n\t\t\t\tcolor = \"#000\"\n\t\t\t\tinitials = username\n\t\t\telse\n\t\t\t\tposition = username.length % colors.length\n\t\t\t\tcolor = colors[position]\n\t\t\t\tusername = username.replace(/[^A-Za-z0-9]/g, '.').replace(/\\.+/g, '.').replace(/(^\\.)|(\\.$)/g, '')\n\t\t\t\tusernameParts = username.split('.')\n\t\t\t\tinitials = if usernameParts.length > 1\n\t\t\t\t\t_.first(usernameParts)[0] + _.last(usernameParts)[0]\n\t\t\t\telse\n\t\t\t\t\tusername.replace(/[^A-Za-z0-9]/g, '').substr(0, 2)\n\t\t\t\tinitials = initials.toUpperCase()\n\n\t\t\tsvg = \"\"\"\n\t\t\t<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?>\n\t\t\t<svg xmlns=\"http://www.w3.org/2000/svg\" pointer-events=\"none\" width=\"50\" height=\"50\" style=\"width: 50px; height: 50px; background-color: #{color};\">\n\t\t\t\t<text text-anchor=\"middle\" y=\"50%\" x=\"50%\" dy=\"0.36em\" pointer-events=\"auto\" fill=\"#ffffff\" font-family=\"Helvetica, Arial, Lucida Grande, sans-serif\" style=\"font-weight: 400; font-size: 28px;\">\n\t\t\t\t\t#{initials}\n\t\t\t\t</text>\n\t\t\t</svg>\n\t\t\t\"\"\"\n\n\t\t\tres.write svg\n\t\t\tres.end()\n\t\t\treturn\n\n\t\treqModifiedHeader = req.headers[\"if-modified-since\"];\n\t\tif reqModifiedHeader?\n\t\t\tif reqModifiedHeader == file.uploadDate?.toUTCString()\n\t\t\t\tres.setHeader 'Last-Modified', reqModifiedHeader\n\t\t\t\tres.writeHead 304\n\t\t\t\tres.end()\n\t\t\t\treturn\n\n\t\tres.setHeader 'Cache-Control', 'public, max-age=0'\n\t\tres.setHeader 'Expires', '-1'\n\t\tres.setHeader 'Last-Modified', file.uploadDate?.toUTCString() or new Date().toUTCString()\n\t\tres.setHeader 'Content-Type', 'image/jpeg'\n\t\tres.setHeader 'Content-Length', file.length\n\n\t\tfile.readStream.pipe res\n\t\treturn\n"]}