{"version":3,"sources":["meteor://ðŸ’»app/server/lib/cordova.coffee"],"names":[],"mappings":"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","file":"/server/lib/cordova.coffee.js","sourcesContent":["Meteor.methods\n\tlog: ->\n\t\tconsole.log.apply console, arguments\n\n\tpush_test: ->\n\t\tuser = Meteor.user()\n\t\tif not user?\n\t\t\tthrow new Meteor.Error 'error-not-allowed', 'Not allowed', { method: 'push_test' }\n\n\t\tif not RocketChat.authz.hasRole(user._id, 'admin')\n\t\t\tthrow new Meteor.Error 'error-not-allowed', 'Not allowed', { method: 'push_test' }\n\n\t\tif Push.enabled isnt true\n\t\t\tthrow new Meteor.Error 'error-push-disabled', 'Push is disabled', { method: 'push_test' }\n\n\t\tquery =\n\t\t\t$and: [\n\t\t\t\tuserId: user._id\n\t\t\t\t{\n\t\t\t\t\t$or: [\n\t\t\t\t\t\t{ 'token.apn': { $exists: true } }\n\t\t\t\t\t\t{ 'token.gcm': { $exists: true } }\n\t\t\t\t\t]\n\t\t\t\t}\n\t\t\t]\n\n\t\ttokens = Push.appCollection.find(query).count()\n\n\t\tif tokens is 0\n\t\t\tthrow new Meteor.Error 'error-no-tokens-for-this-user', \"There are no tokens for this user\", { method: 'push_test' }\n\n\t\tPush.send\n\t\t\tfrom: 'push'\n\t\t\ttitle: \"@#{user.username}\"\n\t\t\ttext: TAPi18n.__ \"This_is_a_push_test_messsage\"\n\t\t\tapn:\n\t\t\t\ttext: \"@#{user.username}:\\n\" + TAPi18n.__ \"This_is_a_push_test_messsage\"\n\t\t\tsound: 'chime'\n\t\t\tquery:\n\t\t\t\tuserId: user._id\n\n\t\treturn {} =\n\t\t\tmessage: \"Your_push_was_sent_to_s_devices\"\n\t\t\tparams: [tokens]\n\n\nconfigurePush = ->\n\tif RocketChat.settings.get 'Push_debug'\n\t\tconsole.log 'Push: configuring...'\n\n\tif RocketChat.settings.get('Push_enable') is true\n\t\tPush.allow\n\t\t\tsend: (userId, notification) ->\n\t\t\t\treturn RocketChat.authz.hasRole(userId, 'admin')\n\n\t\tapn = undefined\n\t\tgcm = undefined\n\n\t\tif RocketChat.settings.get('Push_enable_gateway') is false\n\t\t\tgcm =\n\t\t\t\tapiKey: RocketChat.settings.get 'Push_gcm_api_key'\n\t\t\t\tprojectNumber: RocketChat.settings.get 'Push_gcm_project_number'\n\n\t\t\tapn =\n\t\t\t\tpassphrase: RocketChat.settings.get 'Push_apn_passphrase'\n\t\t\t\tkeyData: RocketChat.settings.get 'Push_apn_key'\n\t\t\t\tcertData: RocketChat.settings.get 'Push_apn_cert'\n\n\t\t\tif RocketChat.settings.get('Push_production') isnt true\n\t\t\t\tapn =\n\t\t\t\t\tpassphrase: RocketChat.settings.get 'Push_apn_dev_passphrase'\n\t\t\t\t\tkeyData: RocketChat.settings.get 'Push_apn_dev_key'\n\t\t\t\t\tcertData: RocketChat.settings.get 'Push_apn_dev_cert'\n\t\t\t\t\tgateway: 'gateway.sandbox.push.apple.com'\n\n\t\t\tif not apn.keyData? or apn.keyData.trim() is '' or not apn.keyData? or apn.keyData.trim() is ''\n\t\t\t\tapn = undefined\n\n\t\t\tif not gcm.apiKey? or gcm.apiKey.trim() is '' or not gcm.projectNumber? or gcm.projectNumber.trim() is ''\n\t\t\t\tgcm = undefined\n\n\t\tPush.Configure\n\t\t\tapn: apn\n\t\t\tgcm: gcm\n\t\t\tproduction: RocketChat.settings.get 'Push_production'\n\t\t\tsendInterval: 1000\n\t\t\tsendBatchSize: 10\n\n\t\tif RocketChat.settings.get('Push_enable_gateway') is true\n\t\t\tPush.serverSend = (options) ->\n\t\t\t\toptions = options or { badge: 0 }\n\t\t\t\tquery = undefined\n\n\t\t\t\tif options.from isnt ''+options.from\n\t\t\t\t\tthrow new Error('Push.send: option \"from\" not a string')\n\n\t\t\t\tif options.title isnt ''+options.title\n\t\t\t\t\tthrow new Error('Push.send: option \"title\" not a string')\n\n\t\t\t\tif options.text isnt ''+options.text\n\t\t\t\t\tthrow new Error('Push.send: option \"text\" not a string')\n\n\t\t\t\tif RocketChat.settings.get 'Push_debug'\n\t\t\t\t\tconsole.log('Push: send message \"' + options.title + '\" via query', options.query)\n\n\t\t\t\tquery =\n\t\t\t\t\t$and: [\n\t\t\t\t\t\toptions.query\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$or: [\n\t\t\t\t\t\t\t\t{ 'token.apn': { $exists: true } }\n\t\t\t\t\t\t\t\t{ 'token.gcm': { $exists: true } }\n\t\t\t\t\t\t\t]\n\t\t\t\t\t\t}\n\t\t\t\t\t]\n\n\t\t\t\tPush.appCollection.find(query).forEach (app) ->\n\t\t\t\t\tif RocketChat.settings.get 'Push_debug'\n\t\t\t\t\t\tconsole.log('Push: send to token', app.token)\n\n\t\t\t\t\tif app.token.apn?\n\t\t\t\t\t\tservice = 'apn'\n\t\t\t\t\t\ttoken = app.token.apn\n\t\t\t\t\telse if app.token.gcm?\n\t\t\t\t\t\tservice = 'gcm'\n\t\t\t\t\t\ttoken = app.token.gcm\n\n\t\t\t\t\tsendPush service, token, options\n\n\t\tPush.enabled = true\n\nsendPush = (service, token, options, tries=0) ->\n\tdata =\n\t\tdata:\n\t\t\ttoken: token\n\t\t\toptions: options\n\n\tHTTP.post RocketChat.settings.get('Push_gateway') + \"/push/#{service}/send\", data, (error, response) ->\n\t\tif response?.statusCode is 406\n\t\t\tconsole.log('removing push token', token)\n\t\t\tPush.appCollection.remove({\n\t\t\t\t$or: [\n\t\t\t\t\t\t{ 'token.apn': token }\n\t\t\t\t\t\t{ 'token.gcm': token }\n\t\t\t\t\t]\n\t\t\t})\n\t\t\treturn\n\n\t\tif not error?\n\t\t\treturn\n\n\t\tSystemLogger.error 'Error sending push to gateway ('+tries+' try) ->', error\n\t\tif tries <= 6\n\t\t\tmilli = Math.pow(10, tries+2)\n\n\t\t\tSystemLogger.log 'Trying sending push to gateway again in', milli, 'milliseconds'\n\n\t\t\t# Try again in 0.1s, 1s, 10s, 1m40s, 16m40s, 2h46m40s and 27h46m40s\n\t\t\tMeteor.setTimeout ->\n\t\t\t\tsendPush service, token, options, tries+1\n\t\t\t, milli\n\nMeteor.startup ->\n\tconfigurePush()\n\n\t## Prepared to reconfigure the push plugin\n\t#\n\t# keys = [\n\t# \t'Push_enable'\n\t# \t'Push_enable_gateway'\n\t# \t'Push_gcm_api_key'\n\t# \t'Push_gcm_project_number'\n\t# \t'Push_apn_passphrase'\n\t# \t'Push_apn_key'\n\t# \t'Push_apn_cert'\n\t# \t'Push_production'\n\t# \t'Push_apn_dev_passphrase'\n\t# \t'Push_apn_dev_key'\n\t# \t'Push_apn_dev_cert'\n\t# \t'Push_gateway'\n\t# ]\n\n\t# configurePushDebounce = _.debounce Meteor.bindEnvironment(configurePush), 1000\n\n\t# RocketChat.settings.onload keys, ->\n\t# \tconfigurePushDebounce()\n\n"]}