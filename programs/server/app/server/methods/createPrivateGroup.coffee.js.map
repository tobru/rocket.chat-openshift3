{"version":3,"sources":["meteor://ðŸ’»app/server/methods/createPrivateGroup.coffee"],"names":[],"mappings":";;;;;;;;;AAAA,MAAM,CAAC,OAAP,CACC;AAAA,sBAAoB,SAAC,IAAD,EAAO,OAAP;AACnB;AAAA,QAAG,OAAU,CAAC,MAAP,EAAP;AACC,YAAU,UAAM,CAAC,KAAP,CAAa,oBAAb,EAAmC,cAAnC,EAAmD;AAAA,QAAE,QAAQ,oBAAV;OAAnD,CAAV,CADD;KAAA;AAGA,mBAAiB,CAAC,KAAK,CAAC,aAAjB,CAA+B,MAAM,CAAC,MAAP,EAA/B,EAAgD,UAAhD,CAAP;AACC,YAAU,UAAM,CAAC,KAAP,CAAa,mBAAb,EAAkC,aAAlC,EAAiD;AAAA,QAAE,QAAQ,oBAAV;OAAjD,CAAV,CADD;KAHA;AAMA;AACC,uBAAqB,WAAO,MAAM,UAAU,CAAC,QAAQ,CAAC,GAApB,CAAwB,uBAAxB,CAAN,GAAyD,GAAhE,CAArB,CADD;KAAA;AAGC,uBAAqB,WAAO,mBAAP,CAArB,CAHD;KANA;AAWA,QAAG,eAAkB,CAAC,IAAf,CAAoB,IAApB,CAAP;AACC,YAAU,UAAM,CAAC,KAAP,CAAa,oBAAb,EAAmC,cAAnC,EAAmD;AAAA,QAAE,QAAQ,oBAAV;OAAnD,CAAV,CADD;KAXA;AAAA,IAcA,MAAU,UAdV;AAAA,IAgBA,KAAK,MAAM,CAAC,IAAP,EAhBL;AAAA,IAkBA,OAAO,CAAC,IAAR,CAAa,EAAE,CAAC,QAAhB,CAlBA;AAuBA,QAAG,UAAU,CAAC,MAAM,CAAC,KAAK,CAAC,aAAxB,CAAsC,IAAtC,CAAH;AACC,UAAG,UAAU,CAAC,MAAM,CAAC,KAAK,CAAC,aAAxB,CAAsC,IAAtC,CAA2C,CAAC,QAA/C;AACC,cAAU,UAAM,CAAC,KAAP,CAAa,+BAAb,EAA8C,2CAA2C,IAAzF,EAA+F;AAAA,UAAE,QAAQ,oBAAV;AAAA,UAAgC,WAAW,IAA3C;SAA/F,CAAV,CADD;OAAA;AAGC,cAAU,UAAM,CAAC,KAAP,CAAa,8BAAb,EAA6C,0BAA0B,IAA1B,GAAiC,UAA9E,EAA0F;AAAA,UAAE,QAAQ,oBAAV;AAAA,UAAgC,WAAW,IAA3C;SAA1F,CAAV,CAHD;OADD;KAvBA;AAAA,IA8BA,OAAO,UAAU,CAAC,MAAM,CAAC,KAAK,CAAC,kCAAxB,CAA2D,GAA3D,EAAgE,IAAhE,EAAsE,EAAtE,EAA0E,OAA1E,EACN;AAAA,UAAI,GAAJ;KADM,CA9BP;AAiCA;4BAAA;AACC,eAAS,UAAU,CAAC,MAAM,CAAC,KAAK,CAAC,iBAAxB,CAA0C,QAA1C,EAAoD;AAAA,QAAE,QAAQ;AAAA,UAAE,UAAU,CAAZ;SAAV;OAApD,CAAT;AACA,UAAO,cAAP;AACC,iBADD;OADA;AAAA,MAIA,QAAQ,EAJR;AAMA,UAAG,aAAY,EAAE,CAAC,QAAlB;AACC,aAAK,CAAC,EAAN,GAAW,GAAX,CADD;OAAA;AAGC,aAAK,CAAC,KAAN,GAAc,IAAd,CAHD;OANA;AAAA,MAWA,UAAU,CAAC,MAAM,CAAC,aAAa,CAAC,qBAAhC,CAAsD,IAAtD,EAA4D,MAA5D,EAAoE,KAApE,CAXA,CADD;AAAA,KAjCA;AAAA,IAgDA,UAAU,CAAC,KAAK,CAAC,YAAjB,CAA8B,MAAM,CAAC,MAAP,EAA9B,EAA+C,CAAC,OAAD,CAA/C,EAA0D,IAAI,CAAC,GAA/D,CAhDA;AAkDA,WAAO;AAAA,MACN,KAAK,IAAI,CAAC,GADJ;KAAP,CAnDmB;EAAA,CAApB;CADD","file":"/server/methods/createPrivateGroup.coffee.js","sourcesContent":["Meteor.methods\n\tcreatePrivateGroup: (name, members) ->\n\t\tif not Meteor.userId()\n\t\t\tthrow new Meteor.Error 'error-invalid-user', \"Invalid user\", { method: 'createPrivateGroup' }\n\n\t\tunless RocketChat.authz.hasPermission(Meteor.userId(), 'create-p')\n\t\t\tthrow new Meteor.Error 'error-not-allowed', \"Not allowed\", { method: 'createPrivateGroup' }\n\n\t\ttry\n\t\t\tnameValidation = new RegExp '^' + RocketChat.settings.get('UTF8_Names_Validation') + '$'\n\t\tcatch\n\t\t\tnameValidation = new RegExp '^[0-9a-zA-Z-_.]+$'\n\n\t\tif not nameValidation.test name\n\t\t\tthrow new Meteor.Error 'error-invalid-name', \"Invalid name\", { method: 'createPrivateGroup' }\n\n\t\tnow = new Date()\n\n\t\tme = Meteor.user()\n\n\t\tmembers.push me.username\n\n\t\t# name = s.slugify name\n\n\t\t# avoid duplicate names\n\t\tif RocketChat.models.Rooms.findOneByName name\n\t\t\tif RocketChat.models.Rooms.findOneByName(name).archived\n\t\t\t\tthrow new Meteor.Error 'error-archived-duplicate-name', \"There's an archived channel with name \" + name, { method: 'createPrivateGroup', room_name: name }\n\t\t\telse\n\t\t\t\tthrow new Meteor.Error 'error-duplicate-channel-name', \"A channel with name '\" + name + \"' exists\", { method: 'createPrivateGroup', room_name: name }\n\n\t\t# create new room\n\t\troom = RocketChat.models.Rooms.createWithTypeNameUserAndUsernames 'p', name, me, members,\n\t\t\tts: now\n\n\t\tfor username in members\n\t\t\tmember = RocketChat.models.Users.findOneByUsername(username, { fields: { username: 1 }})\n\t\t\tif not member?\n\t\t\t\tcontinue\n\n\t\t\textra = {}\n\n\t\t\tif username is me.username\n\t\t\t\textra.ls = now\n\t\t\telse\n\t\t\t\textra.alert = true\n\n\t\t\tRocketChat.models.Subscriptions.createWithRoomAndUser room, member, extra\n\n\t\t# set creator as group moderator.  permission limited to group by scoping to rid\n\t\tRocketChat.authz.addUserRoles(Meteor.userId(), ['owner'], room._id)\n\n\t\treturn {\n\t\t\trid: room._id\n\t\t}\n"]}