{"version":3,"sources":["meteor://ðŸ’»app/server/methods/createDirectMessage.coffee"],"names":[],"mappings":";;;;;;;;;AAAA,MAAM,CAAC,OAAP,CACC;AAAA,uBAAqB,SAAC,QAAD;AACpB;AAAA,QAAG,OAAU,CAAC,MAAP,EAAP;AACC,YAAU,UAAM,CAAC,KAAP,CAAa,oBAAb,EAAmC,cAAnC,EAAmD;AAAA,QAAE,QAAQ,qBAAV;OAAnD,CAAV,CADD;KAAA;AAAA,IAGA,KAAK,MAAM,CAAC,IAAP,EAHL;AAKA,WAAS,CAAC,QAAV;AACC,YAAU,UAAM,CAAC,KAAP,CAAa,oBAAb,EAAmC,cAAnC,EAAmD;AAAA,QAAE,QAAQ,qBAAV;OAAnD,CAAV,CADD;KALA;AAQA,QAAG,EAAE,CAAC,QAAH,KAAe,QAAlB;AACC,YAAU,UAAM,CAAC,KAAP,CAAa,oBAAb,EAAmC,cAAnC,EAAmD;AAAA,QAAE,QAAQ,qBAAV;OAAnD,CAAV,CADD;KARA;AAWA,QAAG,WAAW,CAAC,KAAK,CAAC,aAAjB,CAA+B,MAAM,CAAC,MAAP,EAA/B,EAAgD,UAAhD,CAAJ;AACC,YAAU,UAAM,CAAC,KAAP,CAAa,mBAAb,EAAkC,aAAlC,EAAiD;AAAA,QAAE,QAAQ,qBAAV;OAAjD,CAAV,CADD;KAXA;AAAA,IAcA,KAAK,UAAU,CAAC,MAAM,CAAC,KAAK,CAAC,iBAAxB,CAA0C,QAA1C,CAdL;AAgBA,QAAG,GAAH;AACC,YAAU,UAAM,CAAC,KAAP,CAAa,oBAAb,EAAmC,cAAnC,EAAmD;AAAA,QAAE,QAAQ,qBAAV;OAAnD,CAAV,CADD;KAhBA;AAAA,IAmBA,MAAM,CAAC,EAAE,CAAC,GAAJ,EAAS,EAAE,CAAC,GAAZ,CAAgB,CAAC,IAAjB,EAAuB,CAAC,IAAxB,CAA6B,EAA7B,CAnBN;AAAA,IAqBA,MAAU,UArBV;AAAA,IAwBA,UAAU,CAAC,MAAM,CAAC,KAAK,CAAC,MAAxB,CACC;AAAA,WAAK,GAAL;KADD,EAGC;AAAA,YACC;AAAA,mBAAW,CAAC,EAAE,CAAC,QAAJ,EAAc,EAAE,CAAC,QAAjB,CAAX;OADD;AAAA,MAEA,cACC;AAAA,WAAG,GAAH;AAAA,QACA,MAAM,CADN;AAAA,QAEA,IAAI,GAFJ;OAHD;KAHD,CAxBA;AAAA,IAmCA,UAAU,CAAC,MAAM,CAAC,aAAa,CAAC,MAAhC,CACC;AAAA,WAAK,GAAL;AAAA,MACA,MAAM;QAAC;AAAA,UAAC,SAAS,EAAE,CAAC,GAAb;SAAD;OADN;KADD,EAIC;AAAA,YACC;AAAA,YAAI,GAAJ;AAAA,QACA,IAAI,GADJ;AAAA,QAEA,MAAM,IAFN;OADD;AAAA,MAIA,cACC;AAAA,cAAM,EAAE,CAAC,QAAT;AAAA,QACA,GAAG,GADH;AAAA,QAEA,OAAO,KAFP;AAAA,QAGA,QAAQ,CAHR;AAAA,QAIA,GACC;AAAA,eAAK,EAAE,CAAC,GAAR;AAAA,UACA,UAAU,EAAE,CAAC,QADb;SALD;OALD;KAJD,CAnCA;AAAA,IAqDA,UAAU,CAAC,MAAM,CAAC,aAAa,CAAC,MAAhC,CACC;AAAA,WAAK,GAAL;AAAA,MACA,MAAM;QAAC;AAAA,UAAC,SAAS,EAAE,CAAC,GAAb;SAAD;OADN;KADD,EAIC;AAAA,oBACC;AAAA,cAAM,EAAE,CAAC,QAAT;AAAA,QACA,GAAG,GADH;AAAA,QAEA,MAAM,KAFN;AAAA,QAGA,OAAO,KAHP;AAAA,QAIA,QAAQ,CAJR;AAAA,QAKA,GACC;AAAA,eAAK,EAAE,CAAC,GAAR;AAAA,UACA,UAAU,EAAE,CAAC,QADb;SAND;OADD;KAJD,CArDA;AAmEA,WAAO;AAAA,MACN,KAAK,GADC;KAAP,CApEoB;EAAA,CAArB;CADD","file":"/server/methods/createDirectMessage.coffee.js","sourcesContent":["Meteor.methods\n\tcreateDirectMessage: (username) ->\n\t\tif not Meteor.userId()\n\t\t\tthrow new Meteor.Error 'error-invalid-user', \"Invalid user\", { method: 'createDirectMessage' }\n\n\t\tme = Meteor.user()\n\n\t\tunless me.username\n\t\t\tthrow new Meteor.Error 'error-invalid-user', \"Invalid user\", { method: 'createDirectMessage' }\n\n\t\tif me.username is username\n\t\t\tthrow new Meteor.Error 'error-invalid-user', \"Invalid user\", { method: 'createDirectMessage' }\n\n\t\tif !RocketChat.authz.hasPermission Meteor.userId(), 'create-d'\n\t\t\tthrow new Meteor.Error 'error-not-allowed', 'Not allowed', { method: 'createDirectMessage' }\n\n\t\tto = RocketChat.models.Users.findOneByUsername username\n\n\t\tif not to\n\t\t\tthrow new Meteor.Error 'error-invalid-user', \"Invalid user\", { method: 'createDirectMessage' }\n\n\t\trid = [me._id, to._id].sort().join('')\n\n\t\tnow = new Date()\n\n\t\t# Make sure we have a room\n\t\tRocketChat.models.Rooms.upsert\n\t\t\t_id: rid\n\t\t,\n\t\t\t$set:\n\t\t\t\tusernames: [me.username, to.username]\n\t\t\t$setOnInsert:\n\t\t\t\tt: 'd'\n\t\t\t\tmsgs: 0\n\t\t\t\tts: now\n\n\t\t# Make user I have a subcription to this room\n\t\tRocketChat.models.Subscriptions.upsert\n\t\t\trid: rid\n\t\t\t$and: [{'u._id': me._id}] # work around to solve problems with upsert and dot\n\t\t,\n\t\t\t$set:\n\t\t\t\tts: now\n\t\t\t\tls: now\n\t\t\t\topen: true\n\t\t\t$setOnInsert:\n\t\t\t\tname: to.username\n\t\t\t\tt: 'd'\n\t\t\t\talert: false\n\t\t\t\tunread: 0\n\t\t\t\tu:\n\t\t\t\t\t_id: me._id\n\t\t\t\t\tusername: me.username\n\n\t\t# Make user the target user has a subcription to this room\n\t\tRocketChat.models.Subscriptions.upsert\n\t\t\trid: rid\n\t\t\t$and: [{'u._id': to._id}] # work around to solve problems with upsert and dot\n\t\t,\n\t\t\t$setOnInsert:\n\t\t\t\tname: me.username\n\t\t\t\tt: 'd'\n\t\t\t\topen: false\n\t\t\t\talert: false\n\t\t\t\tunread: 0\n\t\t\t\tu:\n\t\t\t\t\t_id: to._id\n\t\t\t\t\tusername: to.username\n\n\t\treturn {\n\t\t\trid: rid\n\t\t}\n"]}