{"version":3,"sources":["meteor://ðŸ’»app/server/methods/createChannel.coffee"],"names":[],"mappings":"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","file":"/server/methods/createChannel.coffee.js","sourcesContent":["Meteor.methods\n\tcreateChannel: (name, members) ->\n\t\tif not Meteor.userId()\n\t\t\tthrow new Meteor.Error 'error-invalid-user', \"Invalid user\", { method: 'createChannel' }\n\n\t\ttry\n\t\t\tnameValidation = new RegExp '^' + RocketChat.settings.get('UTF8_Names_Validation') + '$'\n\t\tcatch\n\t\t\tnameValidation = new RegExp '^[0-9a-zA-Z-_.]+$'\n\n\t\tif not nameValidation.test name\n\t\t\tthrow new Meteor.Error 'error-invalid-name', \"Invalid name\", { method: 'createChannel' }\n\n\t\tif RocketChat.authz.hasPermission(Meteor.userId(), 'create-c') isnt true\n\t\t\tthrow new Meteor.Error 'error-not-allowed', \"Not allowed\", { method: 'createChannel' }\n\n\t\tnow = new Date()\n\t\tuser = Meteor.user()\n\n\t\tmembers.push user.username if user.username not in members\n\n\t\t# avoid duplicate names\n\t\tif RocketChat.models.Rooms.findOneByName name\n\t\t\tif RocketChat.models.Rooms.findOneByName(name).archived\n\t\t\t\tthrow new Meteor.Error 'error-archived-duplicate-name', \"There's an archived channel with name \" + name, { method: 'createChannel', room_name: name }\n\t\t\telse\n\t\t\t\tthrow new Meteor.Error 'error-duplicate-channel-name', \"A channel with name '\" + name + \"' exists\", { method: 'createChannel', room_name: name }\n\n\t\t# name = s.slugify name\n\n\t\tRocketChat.callbacks.run 'beforeCreateChannel', user,\n\t\t\tt: 'c'\n\t\t\tname: name\n\t\t\tts: now\n\t\t\tusernames: members\n\t\t\tu:\n\t\t\t\t_id: user._id\n\t\t\t\tusername: user.username\n\n\t\t# create new room\n\t\troom = RocketChat.models.Rooms.createWithTypeNameUserAndUsernames 'c', name, user, members,\n\t\t\tts: now\n\n\t\tfor username in members\n\t\t\tmember = RocketChat.models.Users.findOneByUsername username\n\t\t\tif not member?\n\t\t\t\tcontinue\n\n\t\t\textra = {}\n\n\t\t\tif username is user.username\n\t\t\t\textra.ls = now\n\t\t\t\textra.open = true\n\n\t\t\tRocketChat.models.Subscriptions.createWithRoomAndUser room, member, extra\n\n\t\t# set creator as channel moderator.  permission limited to channel by scoping to rid\n\t\tRocketChat.authz.addUserRoles(Meteor.userId(), ['owner'], room._id)\n\n\t\tMeteor.defer ->\n\t\t\tRocketChat.callbacks.run 'afterCreateChannel', user, room\n\n\t\treturn {\n\t\t\trid: room._id\n\t\t}\n"]}