{"version":3,"sources":["meteor://ðŸ’»app/server/methods/deleteMessage.coffee"],"names":[],"mappings":"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","file":"/server/methods/deleteMessage.coffee.js","sourcesContent":["Meteor.methods\n\tdeleteMessage: (message) ->\n\t\tif not Meteor.userId()\n\t\t\tthrow new Meteor.Error 'error-invalid-user', 'Invalid user', { method: 'deleteMessage' }\n\n\t\toriginalMessage = RocketChat.models.Messages.findOneById message._id, {fields: {u: 1, rid: 1, file: 1}}\n\t\tif not originalMessage?\n\t\t\tthrow new Meteor.Error 'error-action-not-allowed', 'Not allowed', { method: 'deleteMessage', action: 'Delete_message' }\n\n\t\thasPermission = RocketChat.authz.hasPermission(Meteor.userId(), 'delete-message', originalMessage.rid)\n\t\tdeleteAllowed = RocketChat.settings.get 'Message_AllowDeleting'\n\n\t\tdeleteOwn = originalMessage?.u?._id is Meteor.userId()\n\n\t\tunless hasPermission or (deleteAllowed and deleteOwn)\n\t\t\tthrow new Meteor.Error 'error-action-not-allowed', 'Not allowed', { method: 'deleteMessage', action: 'Delete_message' }\n\n\t\tblockDeleteInMinutes = RocketChat.settings.get 'Message_AllowDeleting_BlockDeleteInMinutes'\n\t\tif blockDeleteInMinutes? and blockDeleteInMinutes isnt 0\n\t\t\tmsgTs = moment(originalMessage.ts) if originalMessage.ts?\n\t\t\tcurrentTsDiff = moment().diff(msgTs, 'minutes') if msgTs?\n\t\t\tif currentTsDiff > blockDeleteInMinutes\n\t\t\t\tthrow new Meteor.Error 'error-message-deleting-blocked', 'Message deleting is blocked', { method: 'deleteMessage' }\n\n\n\t\tkeepHistory = RocketChat.settings.get 'Message_KeepHistory'\n\t\tshowDeletedStatus = RocketChat.settings.get 'Message_ShowDeletedStatus'\n\n\t\tif keepHistory\n\t\t\tif showDeletedStatus\n\t\t\t\tRocketChat.models.Messages.cloneAndSaveAsHistoryById originalMessage._id\n\t\t\telse\n\t\t\t\tRocketChat.models.Messages.setHiddenById originalMessage._id, true\n\n\t\t\tif originalMessage.file?._id?\n\t\t\t\tRocketChat.models.Uploads.update originalMessage.file._id, {$set: {_hidden: true}}\n\n\t\telse\n\t\t\tif not showDeletedStatus\n\t\t\t\tRocketChat.models.Messages.removeById originalMessage._id\n\n\t\t\tif originalMessage.file?._id?\n\t\t\t\tFileUpload.delete(originalMessage.file._id)\n\n\t\tif showDeletedStatus\n\t\t\tRocketChat.models.Messages.setAsDeletedById originalMessage._id\n\t\telse\n\t\t\tRocketChat.Notifications.notifyRoom originalMessage.rid, 'deleteMessage', {_id: originalMessage._id}\n"]}