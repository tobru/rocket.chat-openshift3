{"version":3,"sources":["meteor://ğŸ’»app/server/methods/loadSurroundingMessages.coffee"],"names":[],"mappings":";;;;;;;;;AAAA,MAAM,CAAC,OAAP,CACC;AAAA,2BAAyB,SAAC,OAAD,EAAU,KAAV;AACxB;;MADkC,QAAM;KACxC;AAAA,QAAG,OAAU,CAAC,MAAP,EAAP;AACC,YAAU,UAAM,CAAC,KAAP,CAAa,oBAAb,EAAmC,cAAnC,EAAmD;AAAA,QAAE,QAAQ,yBAAV;OAAnD,CAAV,CADD;KAAA;AAAA,IAGA,SAAS,MAAM,CAAC,MAAP,EAHT;AAKA,gBAAc,CAAC,GAAf;AACC,aAAO,KAAP,CADD;KALA;AAAA,IAQA,UAAU,UAAU,CAAC,MAAM,CAAC,QAAQ,CAAC,WAA3B,CAAuC,OAAO,CAAC,GAA/C,CARV;AAUA,4BAAO,OAAO,CAAE,aAAhB;AACC,aAAO,KAAP,CADD;KAVA;AAaA,eAAa,CAAC,IAAP,CAAY,eAAZ,EAA6B,OAAO,CAAC,GAArC,EAA0C,MAA1C,CAAP;AACC,aAAO,KAAP,CADD;KAbA;AAAA,IAgBA,QAAQ,QAAQ,CAhBhB;AAAA,IAkBA,UACC;AAAA,YACC;AAAA,YAAI,EAAJ;OADD;AAAA,MAEA,OAAO,IAAI,CAAC,IAAL,CAAU,QAAM,CAAhB,CAFP;KAnBD;AAuBA,QAAG,WAAc,CAAC,QAAQ,CAAC,GAApB,CAAwB,0BAAxB,CAAP;AACC,aAAO,CAAC,MAAR,GAAiB;AAAA,QAAE,YAAY,CAAd;OAAjB,CADD;KAvBA;AAAA,IA0BA,UAAU,UAAU,CAAC,MAAM,CAAC,QAAQ,CAAC,kCAA3B,CAA8D,OAAO,CAAC,GAAtE,EAA2E,OAAO,CAAC,EAAnF,EAAuF,OAAvF,CAA+F,CAAC,KAAhG,EA1BV;AAAA,IA2BA,WAAW,CAAC,CAAC,GAAF,CAAM,OAAN,EAAe,SAAC,OAAD;AACzB,aAAO,CAAC,OAAR,GAAkB,CAAC,CAAC,SAAF,CAAY,OAAO,CAAC,OAApB,EAA6B;AAAA,QAAE,KAAK,MAAP;OAA7B,CAAlB;AACA,aAAO,OAAP,CAFyB;IAAA,CAAf,CA3BX;AAAA,IA+BA,aAAa,QAAQ,CAAC,MAAT,KAAmB,OAAO,CAAC,KA/BxC;AAAA,IAiCA,QAAQ,CAAC,IAAT,CAAc,OAAd,CAjCA;AAAA,IAmCA,OAAO,CAAC,IAAR,GAAe;AAAA,MAAE,IAAI,CAAN;KAnCf;AAAA,IAoCA,OAAO,CAAC,KAAR,GAAgB,IAAI,CAAC,KAAL,CAAW,QAAM,CAAjB,CApChB;AAAA,IAsCA,UAAU,UAAU,CAAC,MAAM,CAAC,QAAQ,CAAC,iCAA3B,CAA6D,OAAO,CAAC,GAArE,EAA0E,OAAO,CAAC,EAAlF,EAAsF,OAAtF,CAA8F,CAAC,KAA/F,EAtCV;AAAA,IAuCA,gBAAgB,CAAC,CAAC,GAAF,CAAM,OAAN,EAAe,SAAC,OAAD;AAC9B,aAAO,CAAC,OAAR,GAAkB,CAAC,CAAC,SAAF,CAAY,OAAO,CAAC,OAApB,EAA6B;AAAA,QAAE,KAAK,MAAP;OAA7B,CAAlB;AACA,aAAO,OAAP,CAF8B;IAAA,CAAf,CAvChB;AAAA,IA2CA,YAAY,aAAa,CAAC,MAAd,KAAwB,OAAO,CAAC,KA3C5C;AAAA,IA6CA,WAAW,QAAQ,CAAC,MAAT,CAAgB,aAAhB,CA7CX;AA+CA,WAAO;AAAA,MACN,UAAU,QADJ;AAAA,MAEN,YAAY,UAFN;AAAA,MAGN,WAAW,SAHL;KAAP,CAhDwB;EAAA,CAAzB;CADD","file":"/server/methods/loadSurroundingMessages.coffee.js","sourcesContent":["Meteor.methods\n\tloadSurroundingMessages: (message, limit=50) ->\n\t\tif not Meteor.userId()\n\t\t\tthrow new Meteor.Error 'error-invalid-user', 'Invalid user', { method: 'loadSurroundingMessages' }\n\n\t\tfromId = Meteor.userId()\n\n\t\tunless message._id\n\t\t\treturn false\n\n\t\tmessage = RocketChat.models.Messages.findOneById(message._id);\n\n\t\tunless message?.rid\n\t\t\treturn false\n\n\t\tunless Meteor.call 'canAccessRoom', message.rid, fromId\n\t\t\treturn false\n\n\t\tlimit = limit - 1\n\n\t\toptions =\n\t\t\tsort:\n\t\t\t\tts: -1\n\t\t\tlimit: Math.ceil(limit/2)\n\n\t\tif not RocketChat.settings.get 'Message_ShowEditedStatus'\n\t\t\toptions.fields = { 'editedAt': 0 }\n\n\t\trecords = RocketChat.models.Messages.findVisibleByRoomIdBeforeTimestamp(message.rid, message.ts, options).fetch()\n\t\tmessages = _.map records, (message) ->\n\t\t\tmessage.starred = _.findWhere message.starred, { _id: fromId }\n\t\t\treturn message\n\n\t\tmoreBefore = messages.length is options.limit\n\n\t\tmessages.push message\n\n\t\toptions.sort = { ts: 1 }\n\t\toptions.limit = Math.floor(limit/2)\n\n\t\trecords = RocketChat.models.Messages.findVisibleByRoomIdAfterTimestamp(message.rid, message.ts, options).fetch()\n\t\tafterMessages = _.map records, (message) ->\n\t\t\tmessage.starred = _.findWhere message.starred, { _id: fromId }\n\t\t\treturn message\n\n\t\tmoreAfter = afterMessages.length is options.limit\n\n\t\tmessages = messages.concat afterMessages\n\n\t\treturn {\n\t\t\tmessages: messages\n\t\t\tmoreBefore: moreBefore\n\t\t\tmoreAfter: moreAfter\n\t\t}\n"]}