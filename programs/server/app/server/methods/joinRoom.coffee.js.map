{"version":3,"sources":["meteor://ðŸ’»app/server/methods/joinRoom.coffee"],"names":[],"mappings":";;;;;;;;;AAAA,MAAM,CAAC,OAAP,CACC;AAAA,YAAU,SAAC,GAAD;AACT;AAAA,QAAG,OAAU,CAAC,MAAP,EAAP;AACC,YAAU,UAAM,CAAC,KAAP,CAAa,oBAAb,EAAmC,cAAnC,EAAmD;AAAA,QAAE,QAAQ,UAAV;OAAnD,CAAV,CADD;KAAA;AAAA,IAGA,OAAO,UAAU,CAAC,MAAM,CAAC,KAAK,CAAC,WAAxB,CAAoC,GAApC,CAHP;AAKA,QAAO,YAAP;AACC,YAAU,UAAM,CAAC,KAAP,CAAa,oBAAb,EAAmC,cAAnC,EAAmD;AAAA,QAAE,QAAQ,UAAV;OAAnD,CAAV,CADD;KALA;AAQA,QAAG,IAAI,CAAC,CAAL,KAAY,GAAZ,IAAmB,UAAU,CAAC,KAAK,CAAC,aAAjB,CAA+B,MAAM,CAAC,MAAP,EAA/B,EAAgD,aAAhD,MAAoE,IAA1F;AACC,YAAU,UAAM,CAAC,KAAP,CAAa,mBAAb,EAAkC,aAAlC,EAAiD;AAAA,QAAE,QAAQ,UAAV;OAAjD,CAAV,CADD;KARA;AAAA,IAWA,MAAU,UAXV;AAAA,IAcA,eAAe,UAAU,CAAC,MAAM,CAAC,aAAa,CAAC,wBAAhC,CAAyD,GAAzD,EAA8D,MAAM,CAAC,MAAP,EAA9D,CAdf;AAeA,QAAG,oBAAH;AACC,aADD;KAfA;AAAA,IAkBA,OAAO,UAAU,CAAC,MAAM,CAAC,KAAK,CAAC,WAAxB,CAAoC,MAAM,CAAC,MAAP,EAApC,CAlBP;AAAA,IAoBA,UAAU,CAAC,SAAS,CAAC,GAArB,CAAyB,gBAAzB,EAA2C,IAA3C,EAAiD,IAAjD,CApBA;AAAA,IAsBA,UAAU,CAAC,MAAM,CAAC,KAAK,CAAC,eAAxB,CAAwC,GAAxC,EAA6C,IAAI,CAAC,QAAlD,CAtBA;AAAA,IAwBA,UAAU,CAAC,MAAM,CAAC,aAAa,CAAC,qBAAhC,CAAsD,IAAtD,EAA4D,IAA5D,EACC;AAAA,UAAI,GAAJ;AAAA,MACA,MAAM,IADN;AAAA,MAEA,OAAO,IAFP;AAAA,MAGA,QAAQ,CAHR;KADD,CAxBA;AAAA,IA8BA,UAAU,CAAC,MAAM,CAAC,QAAQ,CAAC,+BAA3B,CAA2D,GAA3D,EAAgE,IAAhE,EACC;AAAA,UAAI,GAAJ;KADD,CA9BA;AAAA,IAiCA,MAAM,CAAC,KAAP,CAAa;aACZ,UAAU,CAAC,SAAS,CAAC,GAArB,CAAyB,eAAzB,EAA0C,IAA1C,EAAgD,IAAhD,EADY;IAAA,CAAb,CAjCA;AAoCA,WAAO,IAAP,CArCS;EAAA,CAAV;CADD","file":"/server/methods/joinRoom.coffee.js","sourcesContent":["Meteor.methods\n\tjoinRoom: (rid) ->\n\t\tif not Meteor.userId()\n\t\t\tthrow new Meteor.Error 'error-invalid-user', 'Invalid user', { method: 'joinRoom' }\n\n\t\troom = RocketChat.models.Rooms.findOneById rid\n\n\t\tif not room?\n\t\t\tthrow new Meteor.Error 'error-invalid-room', 'Invalid room', { method: 'joinRoom' }\n\n\t\tif room.t isnt 'c' or RocketChat.authz.hasPermission(Meteor.userId(), 'view-c-room') isnt true\n\t\t\tthrow new Meteor.Error 'error-not-allowed', 'Not allowed', { method: 'joinRoom' }\n\n\t\tnow = new Date()\n\n\t\t# Check if user is already in room\n\t\tsubscription = RocketChat.models.Subscriptions.findOneByRoomIdAndUserId rid, Meteor.userId()\n\t\tif subscription?\n\t\t\treturn\n\n\t\tuser = RocketChat.models.Users.findOneById Meteor.userId()\n\n\t\tRocketChat.callbacks.run 'beforeJoinRoom', user, room\n\n\t\tRocketChat.models.Rooms.addUsernameById rid, user.username\n\n\t\tRocketChat.models.Subscriptions.createWithRoomAndUser room, user,\n\t\t\tts: now\n\t\t\topen: true\n\t\t\talert: true\n\t\t\tunread: 1\n\n\t\tRocketChat.models.Messages.createUserJoinWithRoomIdAndUser rid, user,\n\t\t\tts: now\n\n\t\tMeteor.defer ->\n\t\t\tRocketChat.callbacks.run 'afterJoinRoom', user, room\n\n\t\treturn true\n"]}