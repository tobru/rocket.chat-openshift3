{"version":3,"sources":["meteor://ðŸ’»app/server/methods/addUserToRoom.coffee"],"names":[],"mappings":";;;;;;;;;AAAA,MAAM,CAAC,OAAP,CACC;AAAA,iBAAe,SAAC,IAAD;AACd;AAAA,QAAG,OAAU,CAAC,MAAP,EAAP;AACC,YAAU,UAAM,CAAC,KAAP,CAAa,oBAAb,EAAmC,cAAnC,EAAmD;AAAA,QAAE,QAAQ,eAAV;OAAnD,CAAV,CADD;KAAA;AAAA,IAGA,SAAS,MAAM,CAAC,MAAP,EAHT;AAIA,cAAY,CAAC,IAAN,gBAAW,IAAI,CAAE,YAAjB,EAAsB,MAAtB,CAAP;AACC,YAAU,UAAM,CAAC,KAAP,CAAa,oBAAb,EAAmC,cAAnC,EAAmD;AAAA,QAAE,QAAQ,eAAV;OAAnD,CAAV,CADD;KAJA;AAOA,cAAY,CAAC,IAAN,gBAAW,IAAI,CAAE,iBAAjB,EAA2B,MAA3B,CAAP;AACC,YAAU,UAAM,CAAC,KAAP,CAAa,wBAAb,EAAuC,kBAAvC,EAA2D;AAAA,QAAE,QAAQ,eAAV;OAA3D,CAAV,CADD;KAPA;AAAA,IAUA,OAAO,UAAU,CAAC,MAAM,CAAC,KAAK,CAAC,WAAxB,CAAoC,IAAI,CAAC,GAAzC,CAVP;AAYA,QAAG,IAAI,CAAC,SAAS,CAAC,OAAf,CAAuB,MAAM,CAAC,IAAP,EAAa,CAAC,QAArC,MAAkD,EAArD;AACC,YAAU,UAAM,CAAC,KAAP,CAAa,mBAAb,EAAkC,aAAlC,EAAiD;AAAA,QAAE,QAAQ,eAAV;OAAjD,CAAV,CADD;KAZA;AAgBA,QAAG,WAAc,CAAC,KAAK,CAAC,aAAjB,CAA+B,MAA/B,EAAuC,kBAAvC,EAA2D,IAAI,CAAC,GAAhE,CAAP;AACC,YAAU,UAAM,CAAC,KAAP,CAAa,mBAAb,EAAkC,aAAlC,EAAiD;AAAA,QAAE,QAAQ,eAAV;OAAjD,CAAV,CADD;KAhBA;AAmBA,QAAG,IAAI,CAAC,CAAL,KAAU,GAAb;AACC,YAAU,UAAM,CAAC,KAAP,CAAa,mCAAb,EAAkD,oCAAlD,EAAwF;AAAA,QAAE,QAAQ,eAAV;OAAxF,CAAV,CADD;KAnBA;AAuBA,QAAG,IAAI,CAAC,SAAS,CAAC,OAAf,CAAuB,IAAI,CAAC,QAA5B,MAA2C,EAA9C;AACC,aADD;KAvBA;AAAA,IA0BA,UAAU,UAAU,CAAC,MAAM,CAAC,KAAK,CAAC,iBAAxB,CAA0C,IAAI,CAAC,QAA/C,CA1BV;AAAA,IA4BA,UAAU,CAAC,MAAM,CAAC,KAAK,CAAC,eAAxB,CAAwC,IAAI,CAAC,GAA7C,EAAkD,IAAI,CAAC,QAAvD,CA5BA;AAAA,IA8BA,MAAU,UA9BV;AAAA,IAgCA,UAAU,CAAC,MAAM,CAAC,aAAa,CAAC,qBAAhC,CAAsD,IAAtD,EAA4D,OAA5D,EACC;AAAA,UAAI,GAAJ;AAAA,MACA,MAAM,IADN;AAAA,MAEA,OAAO,IAFP;AAAA,MAGA,QAAQ,CAHR;KADD,CAhCA;AAAA,IAsCA,WAAW,UAAU,CAAC,MAAM,CAAC,KAAK,CAAC,WAAxB,CAAoC,MAApC,CAtCX;AAAA,IAuCA,UAAU,CAAC,MAAM,CAAC,QAAQ,CAAC,gCAA3B,CAA4D,IAAI,CAAC,GAAjE,EAAsE,OAAtE,EACC;AAAA,UAAI,GAAJ;AAAA,MACA,GACC;AAAA,aAAK,QAAQ,CAAC,GAAd;AAAA,QACA,UAAU,QAAQ,CAAC,QADnB;OAFD;KADD,CAvCA;AA6CA,WAAO,IAAP,CA9Cc;EAAA,CAAf;CADD","file":"/server/methods/addUserToRoom.coffee.js","sourcesContent":["Meteor.methods\n\taddUserToRoom: (data) ->\n\t\tif not Meteor.userId()\n\t\t\tthrow new Meteor.Error 'error-invalid-user', 'Invalid user', { method: 'addUserToRoom' }\n\n\t\tfromId = Meteor.userId()\n\t\tunless Match.test data?.rid, String\n\t\t\tthrow new Meteor.Error 'error-invalid-room', 'Invalid room', { method: 'addUserToRoom' }\n\n\t\tunless Match.test data?.username, String\n\t\t\tthrow new Meteor.Error 'error-invalid-username', 'Invalid username', { method: 'addUserToRoom' }\n\n\t\troom = RocketChat.models.Rooms.findOneById data.rid\n\n\t\tif room.usernames.indexOf(Meteor.user().username) is -1\n\t\t\tthrow new Meteor.Error 'error-not-allowed', 'Not allowed', { method: 'addUserToRoom' }\n\n\t\t# if room.username isnt Meteor.user().username and room.t is 'c'\n\t\tif not RocketChat.authz.hasPermission(fromId, 'add-user-to-room', room._id)\n\t\t\tthrow new Meteor.Error 'error-not-allowed', 'Not allowed', { method: 'addUserToRoom' }\n\n\t\tif room.t is 'd'\n\t\t\tthrow new Meteor.Error 'error-cant-invite-for-direct-room', 'Can\\'t invite user to direct rooms', { method: 'addUserToRoom' }\n\n\t\t# verify if user is already in room\n\t\tif room.usernames.indexOf(data.username) isnt -1\n\t\t\treturn\n\n\t\tnewUser = RocketChat.models.Users.findOneByUsername data.username\n\n\t\tRocketChat.models.Rooms.addUsernameById data.rid, data.username\n\n\t\tnow = new Date()\n\n\t\tRocketChat.models.Subscriptions.createWithRoomAndUser room, newUser,\n\t\t\tts: now\n\t\t\topen: true\n\t\t\talert: true\n\t\t\tunread: 1\n\n\t\tfromUser = RocketChat.models.Users.findOneById fromId\n\t\tRocketChat.models.Messages.createUserAddedWithRoomIdAndUser data.rid, newUser,\n\t\t\tts: now\n\t\t\tu:\n\t\t\t\t_id: fromUser._id\n\t\t\t\tusername: fromUser.username\n\n\t\treturn true\n"]}